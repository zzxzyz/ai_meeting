# REQ-002 会议管理 - 评审报告

## 文档信息

- **需求编号**: REQ-002
- **需求名称**: 会议管理
- **文档类型**: 评审报告
- **版本**: v1.0
- **评审日期**: 2026-02-25
- **评审人**: Team Lead
- **状态**: 通过（附条件）

---

## 1. 评审概述

本次评审综合以下三份前置文档：

| 文档 | 负责人 | 状态 |
|------|--------|------|
| 需求分析 analysis.md | Product Manager | 已完成 |
| UI/UX 设计 ui-ux-design.md | Frontend Leader | 已完成 |
| 技术方案调研 tech_research.md | Architect | 已完成 |

---

## 2. 需求评审意见

### 2.1 优点

- 用户故事（US-001 至 US-006）覆盖完整，每条均有明确验收条件
- 功能边界清晰，In Scope / Out of Scope 区分明确，MVP 范围合理收敛
- 状态机设计（active / ended）简洁，创建即进行中符合 MVP 快速迭代诉求
- 异常处理矩阵完整，HTTP 状态码与业务错误码（5位）规范统一，与 REQ-001 风格一致
- 数据模型设计（meetings / meeting_participants）字段完备，索引考虑充分

### 2.2 问题与建议

#### [P1] 状态枚举不一致（必须解决）

- **问题**: 需求分析文档定义状态为 `active / ended`，技术调研文档定义为 `WAITING / IN_PROGRESS / ENDED`，现有 `MeetingEntity` 使用 `WAITING / ACTIVE / ENDED`，三处定义不一致。
- **影响**: 前后端接口对齐、数据库迁移、代码实现均会产生混乱。
- **建议**: 评审后统一确认最终状态枚举值。推荐采用以下方案：
  - `waiting`（预留，MVP 暂不启用）
  - `active`（进行中，创建即为此状态）
  - `ended`（已结束，终态）
  - 技术调研中 `IN_PROGRESS` 对应 `active`，语义等价，统一使用 `active`。

#### [P2] 历史参与会议列表接口缺失（需补充）

- **问题**: 需求分析 9.1 接口列表中包含 `GET /api/v1/meetings/history`，但后续 API 契约（评审产出）需要将此接口规范化，不应遗漏。
- **建议**: api_contract.md 中明确定义此接口。

#### [P3] 会议标题字段一致性

- **问题**: 需求分析数据模型未包含 `title` 字段，但 UI/UX 设计与技术调研均提到"会议标题（可选，最多 50 字符）"，且现有 `MeetingEntity` 已有 `title` 字段（VARCHAR(100)）。
- **建议**: 需求分析数据模型应补充 `title` 字段；字段长度建议统一为 100 字符（与实体一致）。

#### [P3] 分页参数说明分歧

- **问题**: 需求分析中列表分页默认每页 20 条，UI/UX 设计中列表每页 10 条。
- **建议**: 以 UI/UX 设计的 10 条为准，接口支持 `pageSize` 参数，客户端可灵活配置，默认值由产品确认后统一。

### 2.3 验收标准评审

| 验收项 | 评审意见 |
|--------|---------|
| 会议号全局唯一 | 合理，数据库 UNIQUE 约束兜底 |
| 已结束会议无法加入 | 合理，返回 409 |
| 非创建者无法结束会议 | 合理，返回 403 |
| 会议详情参与人员列表准确 | 合理 |
| 持续时长误差 < 1 秒 | 合理，后端返回时间戳，前端计算 |
| 分页边界值处理 | 合理，page=0 返回 400 |
| API 响应时间 P95 < 200ms | 合理 |

---

## 3. UI/UX 评审意见

### 3.1 优点

- 交互流程图清晰，覆盖创建、加入、列表、详情、结束全路径
- 输入框自动格式化（XXX-XXX-XXX）体验友好，防输入错误
- 权限区分设计合理：仅创建者可见"结束会议"按钮
- 结束会议二次确认弹窗文案准确，操作不可逆提示到位
- 空状态、加载状态、错误状态均有明确设计，体验完整
- 与 REQ-001 视觉一致性明确说明，降低前端实现成本

### 3.2 问题与建议

#### [P2] 会议详情页操作按钮状态说明不完整

- **问题**: 详情页权限区分表中"会议已结束"隐藏所有操作按钮，但未说明已结束会议是否展示"重新加入"按钮（应不展示）；对于创建者，会议进行中是否同时显示"重新加入"和"结束会议"两个按钮需明确。
- **建议**: 补充状态 × 角色的按钮显示矩阵：

  | 角色 | 会议进行中 | 会议已结束 |
  |------|-----------|-----------|
  | 创建者 | 显示"重新加入"和"结束会议" | 不显示操作按钮 |
  | 普通参与者 | 仅显示"重新加入" | 不显示操作按钮 |

#### [P3] 移动端边界未说明

- **问题**: 设计文档明确移动端延后至 v0.2，但 Electron 最小窗口 800px 场景下会议号输入框等组件在小尺寸下的布局未说明。
- **建议**: 补充 800px × 600px 最小尺寸下的关键组件适配说明。

#### [P3] 会议列表"标题"列

- **问题**: 列表设计中有"标题"列，但需求分析数据模型原无 title 字段（已在需求评审中提出），需同步确认。
- **建议**: 与需求对齐后，标题为空时列表展示"-"或"无标题"。

### 3.3 可实现性评估

- 所有 UI 组件均基于 React + TailwindCSS 技术栈，与现有前端架构一致，无技术实现障碍
- 会议号输入自动格式化可通过 input 事件处理，技术成本低
- 骨架屏、Toast、Modal 等均为常见 UI 模式，复用现有或社区组件即可

---

## 4. 技术方案评审意见

### 4.1 优点

- 会议号生成选用"随机数 + 数据库唯一约束 + 重试"方案，实现简单，MVP 阶段 9 亿空间足够
- 状态机领域封装（meeting.entity.ts）符合 DDD 规范，逻辑内聚，易于测试
- 并发控制选用 PostgreSQL `SELECT FOR UPDATE` 悲观锁，无需引入额外中间件，适合 MVP
- 实时通知选用 WebSocket，与后续 REQ-003 信令服务复用连接，架构扩展性好
- 权限检查在 Use Case 层执行，逻辑清晰，测试覆盖容易
- 与现有后端架构（NestJS + DDD + TypeORM + PostgreSQL + Redis）完全兼容，无架构风险

### 4.2 问题与建议

#### [P1] 状态枚举一致性（同需求评审 P1）

- **问题**: tech_research.md 中状态机定义与需求分析、现有实体不一致（见需求评审 2.2）。
- **建议**: 统一使用 `waiting / active / ended`，若需迁移现有数据，优先通过 TypeORM 迁移脚本处理。

#### [P2] 会议结束通知丢失的降级方案需明确

- **问题**: tech_research.md 提到"会议结束通知丢失"风险应对措施为"客户端定期轮询会议状态（降级方案）"，但未在需求分析中体现，也未在 API 中规划轮询端点。
- **建议**: 在接口契约中明确 `GET /api/v1/meetings/:meetingId`（查询会议详情）作为轮询降级端点；客户端在 WebSocket 断连时，每 5 秒轮询一次详情接口确认会议状态。

#### [P2] WebSocket 鉴权机制未定义

- **问题**: tech_research.md 定义了 WebSocket Gateway 和消息格式，但未说明 WebSocket 连接时如何鉴权（建议握手时携带 JWT Token）。
- **建议**: 在接口契约中补充 WebSocket 鉴权说明：客户端在连接时通过 `handshake.auth.token` 携带 Access Token，服务端验证后建立连接。

#### [P3] `duration_seconds` 字段存储与 started_at 关系

- **问题**: 需求分析中会议创建后 `started_at` 自动设置为当前时间（创建即进行中），但技术调研的状态机中 `started_at` 在首个参与者加入时才设置，存在分歧。
- **建议**: MVP 阶段确认以创建时间作为 `started_at`（简化实现），技术调研中的 `WAITING → IN_PROGRESS` 转换逻辑相应调整。

#### [P3] 多节点扩展的 Redis Adapter 时机

- **问题**: tech_research.md 提到 WebSocket 多节点扩展通过 Redis Adapter 实现（Phase 2），但未明确触发条件（并发连接数阈值）。
- **建议**: 在 MVP 上线后，当 WebSocket 并发连接超过 500 时，启动 Redis Adapter 接入计划。

### 4.3 风险可控性评估

| 风险项 | 等级 | 评审意见 |
|--------|------|---------|
| 会议号碰撞 | 低 | 可接受，重试机制 + 唯一约束兜底 |
| 状态转换竞态 | 低 | 行锁方案有效 |
| WebSocket 连接泄露 | 低 | 心跳检测可控 |
| 会议结束通知丢失 | 中 | 需要明确降级方案（见 P2 意见） |
| 状态枚举不一致 | 高 | 必须在实现前解决（见 P1 意见） |

---

## 5. 跨 Team 依赖确认

| 依赖项 | 来源 Team | 目标 Team | 依赖内容 | 优先级 |
|--------|----------|----------|---------|--------|
| JWT 鉴权中间件 | REQ-001 后端 | REQ-002 后端 | 复用 JwtAuthGuard | 已就绪 |
| JwtPayload 类型定义 | REQ-001 后端 | REQ-002 后端 | sub/email/nickname/roles | 已就绪 |
| 会议状态 WebSocket 通知 | REQ-002 后端 | REQ-003 音视频 | meeting:ended 事件 | REQ-002 先行实现 Gateway，REQ-003 接入 |
| 会议 API | REQ-002 后端 | REQ-006 聊天 | 会议 ID / 会议状态 | REQ-002 先行 |
| 会议 API | REQ-002 后端 | REQ-005 屏幕共享 | 会议 ID / 会议状态 | REQ-002 先行 |
| 用户信息（昵称） | REQ-001 后端 | REQ-002 后端 | participants 列表展示昵称 | 通过 JOIN users 表获取 |
| left_at 字段更新 | REQ-003 信令 | REQ-002 后端 | 参与者退出时间由信令层写入 | REQ-003 实现时需遵守 meeting_participants 表结构 |

---

## 6. 评审结论

### 6.1 结论：**通过（附条件）**

满足以下修改条件后，REQ-002 可进入实现阶段：

| 优先级 | 修改项 | 责任方 | 截止时间 |
|--------|--------|--------|---------|
| P1（必须） | 统一状态枚举（active/ended/waiting），更新 analysis.md 和 tech_research.md | 后端 Architect | 实现开始前 |
| P1（必须） | 明确 started_at 赋值时机（创建时 vs 首次加入时） | 后端 Architect + PM | 实现开始前 |
| P2（应该） | WebSocket 鉴权方案补充至 api_contract.md | 后端 Architect | 评审通过后 1 天内 |
| P2（应该） | 补充会议结束通知丢失的降级轮询方案 | 后端 Architect | 评审通过后 1 天内 |
| P2（应该） | 历史参与会议列表接口（/meetings/history）纳入 api_contract.md | Team Lead | 随 api_contract.md 一同产出 |
| P3（建议） | UI 补充详情页按钮状态矩阵 | 前端 Leader | 下一版本迭代前 |
| P3（建议） | 需求分析数据模型补充 title 字段 | PM | 下一版本迭代前 |

---

## 7. 各 Team 工作量评估

### 7.1 后端 Team

| 工作项 | 复杂度 | 工作量估算 |
|--------|--------|-----------|
| 数据库迁移（meetings + meeting_participants 表） | 低 | 0.5 人天 |
| 会议号生成服务 | 低 | 0.5 人天 |
| 创建会议 API（POST /meetings） | 低 | 0.5 人天 |
| 加入会议 API（POST /meetings/join） | 中 | 1 人天 |
| 会议列表 API（GET /meetings + GET /meetings/history） | 中 | 1 人天 |
| 会议详情 API（GET /meetings/:meetingId） | 低 | 0.5 人天 |
| 结束会议 API（POST /meetings/:meetingId/end） | 中 | 1 人天 |
| WebSocket Gateway（会议结束通知） | 中 | 1 人天 |
| 单元测试 + 集成测试（覆盖率 > 90%） | 中 | 2 人天 |
| **合计** | | **约 8 人天** |

### 7.2 前端 Team

| 工作项 | 复杂度 | 工作量估算 |
|--------|--------|-----------|
| 首页/会议入口页面 | 低 | 1 人天 |
| 创建会议弹窗 + 成功展示 | 低 | 1 人天 |
| 加入会议页面（输入格式化 + 错误处理） | 中 | 1 人天 |
| 会议列表页面（Tab 切换 + 分页） | 中 | 1.5 人天 |
| 会议详情页面（参与者列表 + 权限区分） | 中 | 1.5 人天 |
| 结束会议确认弹窗 | 低 | 0.5 人天 |
| WebSocket 客户端集成（会议结束监听） | 中 | 1 人天 |
| API 集成封装 | 低 | 0.5 人天 |
| 单元测试 | 中 | 1.5 人天 |
| **合计** | | **约 9.5 人天** |

### 7.3 客户端 Team（Electron）

| 工作项 | 复杂度 | 工作量估算 |
|--------|--------|-----------|
| 复用 Web 端会议管理功能（渲染进程集成） | 低 | 1 人天 |
| 深度链接支持（会议号参数传递） | 中 | 1 人天 |
| 本地存储（最近会议，electron-store） | 低 | 0.5 人天 |
| 原生通知（会议结束事件） | 低 | 0.5 人天 |
| **合计** | | **约 3 人天** |

### 7.4 测试 Team

| 工作项 | 复杂度 | 工作量估算 |
|--------|--------|-----------|
| API 测试用例设计 | 中 | 1 人天 |
| 接口测试执行（Postman/Jest E2E） | 中 | 1.5 人天 |
| 端到端测试（创建-加入-查看-结束流程） | 中 | 1.5 人天 |
| 权限边界测试（非创建者结束等） | 低 | 0.5 人天 |
| 并发测试 | 高 | 1 人天 |
| 测试报告 | 低 | 0.5 人天 |
| **合计** | | **约 6 人天** |

### 7.5 总工作量汇总

| Team | 工作量 |
|------|--------|
| 后端 | ~8 人天 |
| 前端 | ~9.5 人天 |
| 客户端（Electron） | ~3 人天 |
| 测试 | ~6 人天 |
| **总计** | **~26.5 人天** |

---

## 8. 下一步行动

1. 后端 Architect 和 PM 确认状态枚举统一方案，更新相关文档
2. 后端 Architect 补充 WebSocket 鉴权和降级方案至 api_contract.md
3. 各 Team Leader 评审本报告，确认工作量估算
4. 评审意见中 P1 条件修改完成后，各 Team 启动实现工作
5. 前后端以 api_contract.md 为契约，前端可先基于 Mock 服务开发

---

**文档状态**: 已完成
**评审人**: Team Lead
**评审日期**: 2026-02-25
**下次评审**: 实现完成后验收评审
