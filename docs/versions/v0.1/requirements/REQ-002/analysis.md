# REQ-002: 会议管理 - 需求分析

## 文档信息

- **需求编号**: REQ-002
- **需求名称**: 会议管理
- **优先级**: P0
- **负责 Team**: 后端 + 前端 + 客户端
- **依赖需求**: REQ-001（用户认证系统）
- **创建日期**: 2026-02-25
- **更新日期**: 2026-02-25
- **分析人员**: Product Manager

---

## 1. 需求背景与业务目标

### 1.1 业务背景

会议管理模块是视频会议平台的核心基础设施，为音视频通话（REQ-003）、文字聊天（REQ-006）、屏幕共享（REQ-005）等上层功能提供会议房间的创建、管理和生命周期控制能力。

在 v0.1 MVP 阶段，会议管理聚焦于满足以下业务场景：

- 用户可快速发起一场会议，将会议号分享给其他人
- 用户可通过会议号加入他人创建的会议
- 用户可查看自己的会议历史，了解会议状态
- 会议创建者拥有结束会议的控制权

### 1.2 业务目标

1. **降低发起会议的门槛**：创建会议只需一步操作，自动生成唯一会议号
2. **简化加入流程**：输入 9 位会议号即可加入，无需复杂链接或验证
3. **提供可追溯性**：用户可回顾历史会议，了解参与情况
4. **建立会议秩序**：通过创建者权限控制，确保会议有序结束

### 1.3 依赖说明

- REQ-001 已完成，所有会议相关 API 须通过 JWT Token 鉴权
- 本模块为 REQ-003（音视频）、REQ-006（聊天）等模块的前置依赖
- 本模块的会议状态机将驱动后续模块的进入/退出逻辑

---

## 2. 用户故事（User Stories）

### US-001: 创建会议

> 作为**已登录用户**，我希望**一键创建会议**，以便**快速获得会议号并邀请他人加入**。

**验收条件**：
- 点击"创建会议"后，系统自动生成唯一 9 位数字会议号
- 会议创建成功后，会议状态为"进行中"
- 返回会议号和会议详情，用户可复制分享
- 同一用户可创建多个会议（历史会议不影响新建）

---

### US-002: 加入会议

> 作为**已登录用户**，我希望**通过输入会议号加入会议**，以便**与其他人进行视频通话**。

**验收条件**：
- 输入有效的 9 位会议号后可成功加入会议
- 输入无效或不存在的会议号时给出友好错误提示
- 尝试加入已结束的会议时给出相应提示
- 加入成功后返回会议详情（参与者列表、开始时间等）

---

### US-003: 查看我的会议列表

> 作为**已登录用户**，我希望**查看我创建的会议列表**，以便**了解我发起的会议历史**。

**验收条件**：
- 列表按创建时间降序排列
- 每条记录展示：会议号、会议状态、创建时间、参与人数
- 支持分页加载
- 区分未开始、进行中、已结束三种状态

---

### US-004: 查看历史参与会议列表

> 作为**已登录用户**，我希望**查看我参加过的所有会议**，以便**回顾历史会议信息**。

**验收条件**：
- 列表包含自己创建的和以参与者身份加入的会议
- 按最近参与时间降序排列
- 支持分页加载

---

### US-005: 查看会议详情

> 作为**会议参与者**，我希望**查看当前会议的详细信息**，以便**了解参与人员和会议状态**。

**验收条件**：
- 展示参与人员列表（昵称、加入时间）
- 展示会议开始时间
- 展示会议持续时长（进行中实时更新，已结束显示总时长）
- 展示会议状态（未开始/进行中/已结束）
- 展示会议号

---

### US-006: 结束会议

> 作为**会议创建者**，我希望**结束会议**，以便**终止当前会议并让所有参与者退出**。

**验收条件**：
- 只有会议创建者可以执行结束会议操作
- 结束会议后，会议状态变为"已结束"，记录结束时间
- 会议结束后所有参与者自动收到通知并退出会议
- 已结束的会议无法再被加入
- 非创建者调用结束接口时返回 403 Forbidden

---

## 3. 功能点详细描述

### 3.1 创建会议

#### 3.1.1 功能描述

用户发起创建会议请求，系统自动生成唯一 9 位纯数字会议号，创建会议房间并返回会议信息。

#### 3.1.2 会议号生成规则

- **格式**: 9 位纯数字（例：`123 456 789`）
- **生成方式**: 随机生成，确保全局唯一
- **唯一性保障**: 生成后查询数据库确认不重复，冲突时最多重试 5 次
- **展示格式**: 3-3-3 分组显示（前端展示用，存储为连续数字字符串）
- **有效期**: 会议号与会议绑定，会议结束后会议号不再可用（不复用）

#### 3.1.3 创建规则

- 只有已登录用户可创建会议
- 创建会议后，创建者自动成为第一个参与者
- 会议创建后初始状态为**进行中**（`active`），无需额外"开始"操作
- 会议不设置最大时长限制（MVP 阶段）

#### 3.1.4 异常处理

| 异常场景 | 处理方式 |
|---------|---------|
| 用户未登录 | 返回 401，前端跳转登录页 |
| 会议号生成冲突超过重试次数 | 返回 500，提示"创建失败，请重试" |
| 数据库异常 | 返回 500，提示"创建失败，请稍后重试" |

---

### 3.2 加入会议

#### 3.2.1 功能描述

用户输入 9 位会议号，系统验证会议有效性后将用户加入会议，返回会议详情。

#### 3.2.2 验证规则

- 会议号必须为 9 位纯数字
- 会议号对应的会议必须存在
- 会议状态必须为"进行中"（`active`）
- 已在会议中的用户重复加入时，视为重连，返回当前会议信息（不报错）

#### 3.2.3 参与者记录

- 加入会议时，在 `meeting_participants` 表中记录参与记录
- 记录字段：用户 ID、会议 ID、加入时间
- 同一用户可多次加入（重连场景），每次记录一条参与记录

#### 3.2.4 异常处理

| 异常场景 | HTTP 状态 | 错误码 | 提示信息 |
|---------|-----------|--------|---------|
| 用户未登录 | 401 | 40101 | 请先登录 |
| 会议号格式错误 | 400 | 40201 | 请输入 9 位数字会议号 |
| 会议不存在 | 404 | 40401 | 会议不存在，请确认会议号 |
| 会议已结束 | 409 | 40901 | 该会议已结束，无法加入 |
| 会议尚未开始 | 409 | 40902 | 该会议尚未开始 |

---

### 3.3 会议列表查询

#### 3.3.1 我的会议列表

**查询条件**: 当前登录用户为创建者的所有会议

**返回字段**:
- 会议 ID
- 会议号（9 位）
- 会议状态（未开始/进行中/已结束）
- 创建时间
- 开始时间（如有）
- 结束时间（如有）
- 当前/最终参与人数

**排序**: 按创建时间降序

**分页**:
- 默认每页 20 条
- 支持 `page` 和 `pageSize` 参数
- 返回总记录数

#### 3.3.2 历史参与会议列表

**查询条件**: 当前登录用户作为参与者（包括创建者）参与过的所有会议

**返回字段**: 同我的会议列表

**排序**: 按参与时间（最近加入时间）降序

**分页**: 同上

#### 3.3.3 筛选条件（MVP 阶段）

MVP 阶段不支持状态筛选和时间筛选，后续版本扩展。

---

### 3.4 会议详情查询

#### 3.4.1 功能描述

根据会议 ID 或会议号查询会议详细信息，包括参与人员列表、时间信息等。

#### 3.4.2 返回字段

- **基本信息**: 会议 ID、会议号、会议状态
- **时间信息**: 创建时间、开始时间、结束时间、持续时长
- **创建者信息**: 用户 ID、昵称
- **参与人员列表**:
  - 用户 ID
  - 昵称
  - 加入时间
  - 退出时间（如已退出）
  - 是否为创建者

#### 3.4.3 持续时长计算

- **进行中**: 当前时间 - 开始时间（实时计算，后端返回开始时间戳，前端计算）
- **已结束**: 结束时间 - 开始时间（后端直接计算并存储）
- **未开始**: 无时长

#### 3.4.4 访问权限

- 任何已登录用户均可查询会议详情（通过会议 ID 或会议号）
- 未登录用户返回 401

---

### 3.5 结束会议

#### 3.5.1 功能描述

会议创建者发起结束会议操作，系统将会议状态更新为"已结束"，记录结束时间，并通知所有参与者。

#### 3.5.2 权限控制

- 只有会议创建者可以结束会议（通过 JWT Token 中的 userId 与会议 creator_id 比对）
- 非创建者调用时返回 403 Forbidden

#### 3.5.3 结束流程

1. 验证 Token 有效性，获取当前用户 ID
2. 查询会议信息，验证权限
3. 检查会议是否处于"进行中"状态（只有进行中的会议可以被结束）
4. 更新会议状态为 `ended`，记录 `ended_at` 时间戳
5. 计算并存储会议持续时长（`duration_seconds`）
6. 通过 WebSocket/信令服务通知所有参与者会议已结束（此部分由 REQ-003 实现）
7. 返回操作成功

#### 3.5.4 异常处理

| 异常场景 | HTTP 状态 | 错误码 | 提示信息 |
|---------|-----------|--------|---------|
| 用户未登录 | 401 | 40101 | 请先登录 |
| 会议不存在 | 404 | 40402 | 会议不存在 |
| 非创建者操作 | 403 | 40301 | 仅会议创建者可结束会议 |
| 会议已结束 | 409 | 40903 | 该会议已结束 |
| 会议尚未开始 | 409 | 40904 | 会议尚未开始，无法结束 |

---

### 3.6 会议状态管理

#### 3.6.1 状态定义

| 状态值 | 枚举名 | 说明 |
|--------|--------|------|
| `pending` | 未开始 | 预留状态，MVP 暂不使用（创建即进行中） |
| `active` | 进行中 | 会议已创建且未结束，参与者可加入 |
| `ended` | 已结束 | 会议已结束，不可再加入 |

#### 3.6.2 状态转换图

```
[创建] --> active
active --> ended（创建者执行结束）
```

> MVP 阶段不支持 `pending` 状态（暂定），会议创建即为 `active`。

#### 3.6.3 状态约束

- 处于 `active` 状态的会议才允许新参与者加入
- 只有 `active` 状态的会议才能被结束
- `ended` 状态为终态，不可逆转

---

## 4. Team 拆分

### 4.1 后端 Team

| 工作内容 | 描述 | 交付物 |
|---------|------|--------|
| 会议 CRUD API | 创建、查询、结束会议的 RESTful 接口 | NestJS 控制器 + 服务 |
| 数据库设计 | meetings / meeting_participants 表设计与迁移 | TypeORM 迁移脚本 |
| 会议号生成服务 | 唯一 9 位数字生成逻辑 + 冲突重试 | 会议号生成模块 |
| JWT 鉴权中间件 | 复用 REQ-001 的鉴权中间件 | 无（复用） |
| 参与者管理 | 加入/退出会议的参与者记录 | 参与者服务模块 |
| 会议列表查询 | 分页查询、排序逻辑 | 查询服务 |
| 单元测试 | 覆盖所有 Service 层逻辑 | Jest 测试文件 |
| 集成测试 | 覆盖所有 API 端点 | Jest E2E 测试 |

### 4.2 前端 Team

| 工作内容 | 描述 | 交付物 |
|---------|------|--------|
| 创建会议页面/组件 | 一键创建并展示会议号 | React 组件 |
| 加入会议页面/组件 | 会议号输入框 + 加入逻辑 | React 组件 |
| 会议列表页面 | 我的会议 + 历史会议 Tab | React 页面组件 |
| 会议详情展示 | 参与者列表、时间信息展示 | React 组件 |
| 会议控制栏 | 结束会议按钮（创建者专属） | React 组件 |
| 会议状态展示 | 状态标签（进行中/已结束）+ 计时器 | React 组件 |
| API 集成 | 调用会议管理 API | Axios 封装 |
| 单元测试 | 组件单元测试 | Jest + Testing Library |

### 4.3 客户端 Team（Electron）

| 工作内容 | 描述 | 交付物 |
|---------|------|--------|
| 复用 Web 端会议管理功能 | 80% 代码复用 Web 端实现 | Electron 渲染进程集成 |
| 深度链接支持 | 通过系统协议打开会议（会议号参数传递） | Electron 主进程深度链接处理 |
| 本地存储优化 | 使用 electron-store 持久化最近会议 | electron-store 封装 |
| 原生通知 | 会议结束等事件的系统通知 | Electron 通知模块 |

### 4.4 测试 Team

| 工作内容 | 描述 | 交付物 |
|---------|------|--------|
| API 测试用例设计 | 正向/异常场景测试用例 | test_cases.md |
| 接口测试执行 | Postman / Jest E2E | 测试报告 |
| 端到端测试 | 创建-加入-查看-结束完整流程 | E2E 测试脚本 |
| 权限边界测试 | 非创建者结束会议等边界场景 | 测试用例 |
| 并发测试 | 多用户同时加入同一会议 | 并发测试报告 |
| 测试报告 | 汇总测试结果和问题清单 | test_report.md |

---

## 5. 验收标准

对应 `requirements.md` 中 REQ-002 的验收项：

| 验收项 | 验收条件 | 优先级 |
|--------|---------|--------|
| 用户可成功创建会议并获得会议号 | 调用创建接口后返回 9 位会议号，会议状态为 active | P0 |
| 用户可通过有效会议号加入会议 | 输入正确 9 位会议号后成功加入，返回会议详情 | P0 |
| 输入无效会议号时给出友好提示 | 返回对应错误码和可读的错误消息，前端正确展示 | P0 |
| 会议列表正确显示 | 我的会议和历史会议分别正确列出，分页正常 | P0 |
| 会议创建者可结束会议 | 创建者调用结束接口成功，会议状态变为 ended | P0 |
| 会议结束后用户自动退出 | 结束会议后所有参与者收到通知（需 REQ-003 信令配合） | P0 |
| 单元测试覆盖率 > 90% | CI 管道中单元测试覆盖率检查通过 | P0 |

### 5.1 补充验收标准

- [ ] 会议号全局唯一，不存在重复
- [ ] 已结束的会议无法再被加入（返回 409）
- [ ] 非创建者无法结束他人的会议（返回 403）
- [ ] 会议详情中参与人员列表数据准确
- [ ] 持续时长计算正确（误差 < 1 秒）
- [ ] 分页查询参数有效（边界值处理正确）
- [ ] API 响应时间 P95 < 200ms

---

## 6. 优先级与边界条件

### 6.1 In Scope（v0.1 MVP 范围内）

- 创建会议（生成 9 位会议号）
- 加入会议（输入会议号）
- 查询我创建的会议列表
- 查询我参与的历史会议列表
- 查询会议详情（参与者、时间、状态）
- 结束会议（仅创建者）
- 会议状态管理（active / ended）
- 会议参与者记录（加入时间）

### 6.2 Out of Scope（不在 v0.1 范围内）

- 预约会议（指定未来时间创建）
- 会议密码保护
- 等候室功能（主持人审核加入）
- 会议容量限制配置
- 多主持人/联合主持人
- 踢出参与者
- 会议邀请链接（REQ-009，P2 功能）
- 会议内分组（分组讨论）
- 会议议程管理
- 会议邀请通知（邮件/推送）
- 会议号复用机制

### 6.3 边界条件说明

| 边界场景 | 处理规则 |
|---------|---------|
| 用户创建会议后立即结束，再创建新会议 | 允许，每次创建生成新会议号 |
| 用户同时在多个会议中 | MVP 阶段不限制，允许用户加入多个会议 |
| 参与者在会议中断线重连 | 允许重新加入，记录新的加入记录 |
| 会议号格式含空格或特殊字符 | 前端去除空格后提交，后端校验纯数字 |
| 并发多人同时加入同一会议 | 数据库事务保证参与者记录一致性 |
| 已结束会议的详情查询 | 允许查询，展示历史数据 |
| 分页参数超出范围（如 page=0）| 返回 400 Bad Request |

---

## 7. 非功能性需求

### 7.1 性能需求

| 接口 | P95 响应时间 | 支持并发 QPS |
|------|------------|------------|
| 创建会议 | < 200ms | 100 QPS |
| 加入会议 | < 200ms | 500 QPS |
| 会议列表查询 | < 200ms | 500 QPS |
| 会议详情查询 | < 100ms | 1000 QPS |
| 结束会议 | < 200ms | 50 QPS |

### 7.2 安全需求

- **鉴权**: 所有会议 API 必须携带有效 JWT Token（复用 REQ-001 鉴权中间件）
- **权限隔离**: 结束会议操作必须严格校验创建者身份，防止越权
- **会议号防猜测**: 9 位随机数字（10 亿种组合），配合限流降低穷举风险
- **限流**: 创建会议接口限制 10 次/分钟/用户，加入会议限制 30 次/分钟/用户
- **输入验证**: 前后端双重校验会议号格式（纯 9 位数字）

### 7.3 兼容性需求

#### Web 端浏览器

- Chrome 90+
- Safari 14+
- Firefox 88+
- Edge 90+

#### 桌面端

- Windows 10+（Electron）
- macOS 11+（Electron）

#### API 兼容性

- RESTful API 遵循 OpenAPI 3.0 规范
- Content-Type: application/json
- 响应格式统一（code / message / data）

### 7.4 可靠性需求

- 会议创建接口可用性 > 99.9%
- 会议状态更新原子性（使用数据库事务）
- 会议号唯一性由数据库 UNIQUE 约束兜底

---

## 8. 数据模型设计

### 8.1 会议表（meetings）

**表名**: `meetings`

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PRIMARY KEY | 会议 ID |
| meeting_no | CHAR(9) | UNIQUE, NOT NULL | 9 位数字会议号 |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'active' | 会议状态：active / ended |
| creator_id | UUID | NOT NULL, FK(users.id) | 创建者用户 ID |
| started_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 会议开始时间（创建时自动设置） |
| ended_at | TIMESTAMP | NULLABLE | 会议结束时间 |
| duration_seconds | INTEGER | NULLABLE | 会议持续时长（秒），结束时计算存储 |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 记录创建时间 |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 记录更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `idx_meetings_meeting_no` on `meeting_no`
- INDEX: `idx_meetings_creator_id` on `creator_id`
- INDEX: `idx_meetings_status` on `status`
- INDEX: `idx_meetings_created_at` on `created_at`

### 8.2 会议参与者表（meeting_participants）

**表名**: `meeting_participants`

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PRIMARY KEY | 参与记录 ID |
| meeting_id | UUID | NOT NULL, FK(meetings.id) | 会议 ID |
| user_id | UUID | NOT NULL, FK(users.id) | 参与者用户 ID |
| joined_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 加入时间 |
| left_at | TIMESTAMP | NULLABLE | 退出时间（暂由信令层处理） |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | 记录创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_participants_meeting_id` on `meeting_id`
- INDEX: `idx_participants_user_id` on `user_id`
- INDEX: `idx_participants_joined_at` on `joined_at`

---

## 9. API 接口概览

> 完整接口契约见 `api_contract.md`（评审阶段产出）

### 9.1 接口列表

| 方法 | 路径 | 说明 | 鉴权 |
|------|------|------|------|
| POST | `/api/v1/meetings` | 创建会议 | 必须 |
| POST | `/api/v1/meetings/join` | 加入会议 | 必须 |
| GET | `/api/v1/meetings` | 查询我创建的会议列表 | 必须 |
| GET | `/api/v1/meetings/history` | 查询历史参与会议列表 | 必须 |
| GET | `/api/v1/meetings/:meetingId` | 查询会议详情（by ID） | 必须 |
| GET | `/api/v1/meetings/no/:meetingNo` | 查询会议详情（by 会议号） | 必须 |
| POST | `/api/v1/meetings/:meetingId/end` | 结束会议 | 必须（创建者） |

### 9.2 通用响应格式

```json
{
  "code": 0,
  "message": "操作成功",
  "data": {}
}
```

### 9.3 错误码定义

| 错误码 | HTTP 状态 | 说明 |
|--------|-----------|------|
| 0 | 200/201 | 成功 |
| 40201 | 400 | 会议号格式错误 |
| 40202 | 400 | 分页参数错误 |
| 40301 | 403 | 无权限（仅创建者可操作） |
| 40401 | 404 | 会议不存在 |
| 40901 | 409 | 会议已结束，无法加入 |
| 40902 | 409 | 会议尚未开始 |
| 40903 | 409 | 会议已结束，无法重复结束 |
| 42901 | 429 | 创建会议请求频繁 |
| 42902 | 429 | 加入会议请求频繁 |
| 50000 | 500 | 服务器内部错误 |

---

## 10. 风险评估

### 10.1 技术风险

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|--------|---------|------|---------|
| 会议号生成冲突 | 低 | 创建失败，用户体验差 | 重试机制（最多 5 次），生产环境冲突概率极低 |
| 并发加入导致数据不一致 | 中 | 参与者记录重复或丢失 | 数据库事务 + 乐观锁 |
| 会议状态机并发更新 | 中 | 重复结束或状态错误 | 数据库 CAS 更新（WHERE status = 'active'） |
| 数据库连接池耗尽 | 中 | API 超时 | 合理配置连接池，监控连接数 |

### 10.2 业务风险

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|--------|---------|------|---------|
| 恶意用户暴力猜测会议号加入私密会议 | 中 | 安全隐患 | 加入接口限流；v0.2 考虑会议密码 |
| 参与者网络断开后状态不同步 | 中 | 会议详情数据不准确 | left_at 由信令层（REQ-003）负责更新 |

### 10.3 进度风险

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|--------|---------|------|---------|
| REQ-003 信令未就绪导致结束通知无法测试 | 中 | 结束会议 E2E 测试延后 | 后端 API 与信令解耦，先完成 API 部分 |
| 前后端接口对齐 | 低 | 联调延期 | 提前输出 API 契约文档，Mock 数据开发 |

---

## 11. 后续版本规划

### v0.2 会议管理增强

- 预约会议（指定时间，`pending` 状态启用）
- 会议密码保护
- 等候室功能（主持人审核）
- 会议邀请链接（会议号 + 链接合并）
- 踢出参与者
- 最大参与人数配置

### v0.3 会议管理高级功能

- 多主持人支持
- 会议录制管理与回放
- 会议分组（分组讨论室）
- 会议议程与投票
- 企业级会议管理（会议室）

---

## 12. 附录

### 12.1 术语表

- **会议号（Meeting No）**: 9 位纯数字，用于唯一标识一场会议，供用户输入加入
- **创建者（Creator）**: 发起创建会议的用户，拥有结束会议的权限
- **参与者（Participant）**: 通过会议号加入会议的用户（包括创建者）
- **active**: 会议进行中状态，允许加入
- **ended**: 会议已结束状态，不可加入，为终态

### 12.2 参考文档

- [v0.1 需求列表](../../requirements.md)
- [v0.1 版本规划](../../plan.md)
- [REQ-001 需求分析](../REQ-001/analysis.md)
- [REQ-001 API 契约](../REQ-001/api_contract.md)

---

**文档状态**: 已完成
**审批人**: Team Lead
**审批时间**: 待定
