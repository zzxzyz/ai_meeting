# REQ-003 实时音视频通话 - 测试用例

## 文档信息

- **需求编号**: REQ-003
- **需求名称**: 实时音视频通话
- **测试类型**: 集成测试 + E2E 测试 + 性能测试
- **版本**: v1.0
- **创建日期**: 2026-02-26
- **测试人员**: test-leader
- **测试状态**: 待执行

---

## 测试概览

| 测试类别 | 测试用例数 | 优先级 | 测试目标 |
|---------|-----------|--------|---------|
| WebRTC 连接建立 | 12 | P0 | 验证 ICE/DTLS 握手、Transport 创建、连接状态管理 |
| 音视频采集与发布 | 8 | P0 | 验证设备权限处理、媒体流采集、Producer 创建 |
| 多路流管理与订阅 | 10 | P0 | 验证 Consumer 创建、多路流处理、Simulcast 切换 |
| 弱网适应性测试 | 6 | P0 | 验证 20% 丢包下的音视频可用性 |
| 跨浏览器兼容性 | 9 | P0 | 验证 Chrome/Safari/Firefox 互通 |
| 性能指标验证 | 8 | P0 | 验证延迟、分辨率、帧率等性能指标 |
| 边界条件与错误处理 | 7 | P1 | 验证异常场景处理 |
| **总计** | **60** | | |

---

## 1. WebRTC 连接建立测试用例

### 1.1 正常连接建立流程

#### TC-001: 成功加入音视频房间
- **测试目标**: 验证用户成功加入音视频房间的信令流程
- **前置条件**: 用户已通过 REQ-002 API 加入会议
- **测试步骤**:
  1. 客户端连接 WebSocket 信令服务器（携带 JWT Token + meetingId）
  2. 发送 `rtc:join` 信令
  3. 接收 `rtc:joined` 响应，获取 peerId 和房间内已有 peers 列表
- **预期结果**:
  - 收到 `rtc:joined` 响应，包含有效的 peerId
  - 响应中包含房间内其他参会者的 Producer 信息
  - WebSocket 连接状态为已认证
- **优先级**: P0

#### TC-002: 获取 Router RTP 能力
- **测试目标**: 验证客户端正确获取 mediasoup Router 的 RTP 能力
- **前置条件**: 已成功加入音视频房间
- **测试步骤**:
  1. 发送 `rtc:getRouterRtpCapabilities` 信令
  2. 接收 `rtc:routerRtpCapabilities` 响应
  3. 使用 Device.load() 加载 RTP 能力
- **预期结果**:
  - 成功获取包含 codecs 和 headerExtensions 的 RTP 能力
  - Device 成功加载 RTP 能力，可以创建 Transport
- **优先级**: P0

#### TC-003: 创建发送 Transport
- **测试目标**: 验证成功创建上行（发送）Transport
- **前置条件**: Device 已加载 RTP 能力
- **测试步骤**:
  1. 发送 `rtc:createTransport` 信令（direction: "send"）
  2. 接收 `rtc:transportCreated` 响应
  3. 使用返回的 iceParameters、iceCandidates、dtlsParameters 创建 SendTransport
- **预期结果**:
  - 成功创建 SendTransport
  - Transport 状态为 "connecting"
  - 触发 Transport 的 connect 事件
- **优先级**: P0

#### TC-004: 创建接收 Transport
- **测试目标**: 验证成功创建下行（接收）Transport
- **前置条件**: Device 已加载 RTP 能力
- **测试步骤**:
  1. 发送 `rtc:createTransport` 信令（direction: "recv"）
  2. 接收 `rtc:transportCreated` 响应
  3. 使用返回的参数创建 RecvTransport
- **预期结果**:
  - 成功创建 RecvTransport
  - Transport 状态为 "connecting"
- **优先级**: P0

#### TC-005: Transport DTLS 连接
- **测试目标**: 验证 Transport DTLS 握手成功
- **前置条件**: Transport 已创建
- **测试步骤**:
  1. Transport 触发 connect 事件
  2. 发送 `rtc:connectTransport` 信令，传递 dtlsParameters
  3. 接收 `rtc:transportConnected` 响应
- **预期结果**:
  - DTLS 握手成功
  - Transport 状态变为 "connected"
  - 可以开始媒体流传输
- **优先级**: P0

### 1.2 连接异常场景

#### TC-006: ICE 连接失败处理
- **测试目标**: 验证 ICE 连接失败时的错误处理
- **前置条件**: Transport 已创建
- **测试步骤**:
  1. 模拟 STUN/TURN 服务器不可用
  2. 尝试建立 Transport 连接
  3. 观察连接超时和重试行为
- **预期结果**:
  - Transport 触发 iceConnectionStateChange 事件，状态变为 "failed"
  - 客户端显示连接失败提示
  - 支持手动重试机制
- **优先级**: P0

#### TC-007: DTLS 握手失败处理
- **测试目标**: 验证 DTLS 握手失败时的错误处理
- **前置条件**: Transport 已创建
- **测试步骤**:
  1. 发送错误的 dtlsParameters
  2. 观察 DTLS 握手失败处理
- **预期结果**:
  - 收到 `error` 信令响应
  - Transport 状态变为 "failed"
  - 客户端显示 DTLS 握手失败提示
- **优先级**: P0

#### TC-008: 网络中断重连机制
- **测试目标**: 验证网络中断后的自动重连机制
- **前置条件**: 已建立完整音视频连接
- **测试步骤**:
  1. 模拟网络中断（断开 WebSocket 连接）
  2. 等待 3 秒后恢复网络
  3. 观察自动重连行为
- **预期结果**:
  - 客户端检测到网络中断，显示"重新连接中..."
  - 自动尝试重连（最多 5 次）
  - 重连成功后媒体流自动恢复
- **优先级**: P0

---

## 2. 音视频采集与发布测试用例

### 2.1 设备权限处理

#### TC-009: 摄像头/麦克风权限允许
- **测试目标**: 验证用户允许设备权限时的正常流程
- **前置条件**: 用户首次访问页面
- **测试步骤**:
  1. 调用 navigator.mediaDevices.getUserMedia()
  2. 用户点击"允许"权限请求
  3. 获取音视频 MediaStream
- **预期结果**:
  - 成功获取包含音视频轨道的 MediaStream
  - 本地视频预览正常显示
  - 可以开始发布媒体流
- **优先级**: P0

#### TC-010: 摄像头权限拒绝处理
- **测试目标**: 验证摄像头权限被拒绝时的降级处理
- **前置条件**: 用户访问页面
- **测试步骤**:
  1. 调用 getUserMedia()
  2. 用户拒绝摄像头权限但允许麦克风权限
  3. 观察降级处理
- **预期结果**:
  - 仅获取音频 MediaStream
  - 视频位置显示用户头像或占位符
  - 可以正常发布音频流
  - 显示"摄像头权限未开启"提示
- **优先级**: P0

#### TC-011: 麦克风权限拒绝处理
- **测试目标**: 验证麦克风权限被拒绝时的降级处理
- **前置条件**: 用户访问页面
- **测试步骤**:
  1. 调用 getUserMedia()
  2. 用户拒绝麦克风权限但允许摄像头权限
  3. 观察降级处理
- **预期结果**:
  - 仅获取视频 MediaStream
  - 可以正常发布视频流
  - 显示"麦克风权限未开启"提示
- **优先级**: P0

#### TC-012: 设备不存在处理
- **测试目标**: 验证设备不存在时的错误处理
- **前置条件**: 系统无摄像头/麦克风设备
- **测试步骤**:
  1. 调用 getUserMedia()
  2. 观察设备枚举结果
- **预期结果**:
  - 返回 OverconstrainedError
  - 显示"未检测到摄像头/麦克风"提示
  - 允许仅音频/仅视频入会
- **优先级**: P0

### 2.2 媒体流发布

#### TC-013: 音频 Producer 创建
- **测试目标**: 验证成功创建音频 Producer
- **前置条件**: SendTransport 已连接，已获取音频轨道
- **测试步骤**:
  1. 调用 sendTransport.produce() 发布音频轨道
  2. 发送 `rtc:produce` 信令
  3. 接收 `rtc:produced` 响应
- **预期结果**:
  - 成功创建音频 Producer
  - 收到 producerId
  - 音频开始上传到 SFU
- **优先级**: P0

#### TC-014: 视频 Producer 创建（Simulcast）
- **测试目标**: 验证成功创建支持 Simulcast 的视频 Producer
- **前置条件**: SendTransport 已连接，已获取视频轨道
- **测试步骤**:
  1. 配置 Simulcast encodings（r0: 320x180, r1: 640x360, r2: 1280x720）
  2. 调用 sendTransport.produce() 发布视频轨道
  3. 发送 `rtc:produce` 信令
  4. 接收 `rtc:produced` 响应
- **预期结果**:
  - 成功创建视频 Producer
  - 同时上传 3 层 Simulcast 流
  - 收到 producerId
- **优先级**: P0

#### TC-015: 媒体流质量验证
- **测试目标**: 验证发布的媒体流质量符合要求
- **前置条件**: 音频和视频 Producer 已创建
- **测试步骤**:
  1. 使用 WebRTC stats API 监控媒体流质量
  2. 验证视频分辨率、帧率、码率
  3. 验证音频采样率、码率
- **预期结果**:
  - 视频分辨率达到 1280x720（良好网络）
  - 视频帧率 ≥ 30fps
  - 音频采样率 48000Hz，码率 32kbps
- **优先级**: P0

---

## 3. 多路流管理与订阅测试用例

### 3.1 远端流订阅

#### TC-016: 新 Producer 通知与订阅
- **测试目标**: 验证新参会者加入时的自动订阅机制
- **前置条件**: 已有 1 人参会，新用户加入
- **测试步骤**:
  1. 监听 `rtc:newProducer` 事件
  2. 收到新 Producer 通知后发送 `rtc:consume` 信令
  3. 接收 `rtc:consumed` 响应，创建 Consumer
  4. 恢复 Consumer 开始接收数据
- **预期结果**:
  - 成功接收到新参会者的音视频流
  - 远端视频正常渲染到 `<video>` 元素
  - 音频正常播放
- **优先级**: P0

#### TC-017: 多路流同时订阅（4 人场景）
- **测试目标**: 验证最多 4 路音视频流同时订阅的性能
- **前置条件**: 4 人参会，每人发布音视频流
- **测试步骤**:
  1. 每个参会者订阅其他 3 人的音视频流
  2. 观察 4 路视频同时渲染的性能
  3. 监控 CPU 和内存使用情况
- **预期结果**:
  - 4 路视频同时流畅播放
  - 音频正常混合播放，无回声
  - CPU 使用率 < 80%，内存使用稳定
- **优先级**: P0

#### TC-018: 超出 4 人限制处理
- **测试目标**: 验证第 5 人尝试建立媒体连接时的处理
- **前置条件**: 已有 4 人参会
- **测试步骤**:
  1. 第 5 人尝试加入音视频房间
  2. 观察信令服务响应
- **预期结果**:
  - 信令服务拒绝第 5 人的媒体连接请求
  - 返回错误码 40901（会议已满）
  - 显示友好提示"当前会议已达到最大参会人数（4人）"
- **优先级**: P0

### 3.2 Simulcast 自适应切换

#### TC-019: 网络良好时使用高层流
- **测试目标**: 验证良好网络下自动选择高层 Simulcast 流
- **前置条件**: 网络带宽 > 1500kbps
- **测试步骤**:
  1. 订阅远端视频流
  2. 观察 mediasoup 自动选择的 Simulcast 层
  3. 验证视频质量
- **预期结果**:
  - 自动选择 r2 层（1280x720）
  - 视频清晰度高，无明显卡顿
  - 帧率稳定在 30fps
- **优先级**: P0

#### TC-020: 网络一般时使用中层流
- **测试目标**: 验证中等网络下自动选择中层 Simulcast 流
- **前置条件**: 网络带宽 300-1500kbps
- **测试步骤**:
  1. 限制网络带宽到 800kbps
  2. 订阅远端视频流
  3. 观察 Simulcast 层切换
- **预期结果**:
  - 自动选择 r1 层（640x360）
  - 视频质量适中，无明显卡顿
  - 帧率稳定在 24fps
- **优先级**: P0

#### TC-021: 网络差时使用低层流
- **测试目标**: 验证差网络下自动选择低层 Simulcast 流
- **前置条件**: 网络带宽 < 300kbps
- **测试步骤**:
  1. 限制网络带宽到 200kbps
  2. 订阅远端视频流
  3. 观察 Simulcast 层切换
- **预期结果**:
  - 自动选择 r0 层（320x180）
  - 视频基本可用，可能有轻微卡顿
  - 优先保证音频质量
- **优先级**: P0

### 3.3 参会者动态管理

#### TC-022: 参会者加入事件广播
- **测试目标**: 验证新参会者加入时的广播通知
- **前置条件**: 已有参会者在房间内
- **测试步骤**:
  1. 新用户加入会议
  2. 观察 `rtc:peerJoined` 事件广播
- **预期结果**:
  - 所有现有参会者收到 `rtc:peerJoined` 通知
  - 通知包含新参会者的 peerId、userId、nickname
  - 视频网格自动调整布局
- **优先级**: P0

#### TC-023: 参会者离开事件广播
- **测试目标**: 验证参会者离开时的广播通知
- **前置条件**: 多人会议进行中
- **测试步骤**:
  1. 某参会者主动离开或网络断开
  2. 观察 `rtc:peerLeft` 事件广播
- **预期结果**:
  - 所有其他参会者收到 `rtc:peerLeft` 通知
  - 通知包含离开者的 peerId、userId
  - 对应的 Producer 被关闭，Consumer 被清理
  - 视频网格自动调整布局
- **优先级**: P0

#### TC-024: Producer 关闭通知
- **测试目标**: 验证 Producer 关闭时的通知机制
- **前置条件**: 参会者发布媒体流中
- **测试步骤**:
  1. 参会者关闭摄像头或麦克风
  2. 观察 `rtc:producerClosed` 事件广播
- **预期结果**:
  - 所有订阅者收到 `rtc:producerClosed` 通知
  - 对应的 Consumer 被关闭
  - 视频/音频停止播放
- **优先级**: P0

---

## 4. 弱网适应性测试用例

### 4.1 20% 丢包场景测试

#### TC-025: 20% 丢包下音频可用性
- **测试目标**: 验证 20% 丢包率下音频通话的可用性
- **前置条件**: 正常音视频通话建立
- **测试步骤**:
  1. 使用 tc netem 模拟 20% 丢包
  2. 进行双向语音通话
  3. 评估音频质量
- **预期结果**:
  - 音频通话基本可用
  - 可能有轻微失真或断续
  - Opus FEC 机制有效抵抗部分丢包
- **优先级**: P0

#### TC-026: 20% 丢包下视频降级
- **测试目标**: 验证 20% 丢包率下视频自动降级机制
- **前置条件**: 正常音视频通话建立
- **测试步骤**:
  1. 使用 tc netem 模拟 20% 丢包
  2. 观察视频 Simulcast 层切换
  3. 评估视频质量
- **预期结果**:
  - 视频自动降级到较低分辨率（如 360p 或 180p）
  - 视频不中断，保持基本可用
  - NACK 重传机制有效
- **优先级**: P0

#### TC-027: 弱网恢复后质量提升
- **测试目标**: 验证网络恢复后音视频质量自动提升
- **前置条件**: 弱网环境下音视频通话进行中
- **测试步骤**:
  1. 移除网络限制，恢复正常网络
  2. 观察音视频质量恢复过程
- **预期结果**:
  - 视频自动切换回高分辨率层
  - 音频质量恢复正常
  - 恢复过程平滑，无明显卡顿
- **优先级**: P0

### 4.2 网络抖动测试

#### TC-028: 网络抖动下的稳定性
- **测试目标**: 验证网络抖动环境下的通话稳定性
- **前置条件**: 正常音视频通话建立
- **测试步骤**:
  1. 使用 tc netem 模拟 50ms 网络抖动
  2. 进行音视频通话
  3. 观察连接稳定性
- **预期结果**:
  - 音视频通话保持稳定
  - 无明显卡顿或中断
  - jitter buffer 机制有效
- **优先级**: P0

#### TC-029: 带宽限制下的自适应
- **测试目标**: 验证带宽限制下的码率自适应
- **前置条件**: 正常音视频通话建立
- **测试步骤**:
  1. 使用 tc 限制上行带宽为 500kbps
  2. 观察视频码率自适应
- **预期结果**:
  - 视频码率自动调整到适合带宽的水平
  - GCC 拥塞控制机制有效
  - 保持基本通话质量
- **优先级**: P0

---

## 5. 跨浏览器兼容性测试用例

### 5.1 浏览器两两互通测试

#### TC-030: Chrome ↔ Safari 互通
- **测试目标**: 验证 Chrome 和 Safari 之间的音视频互通
- **前置条件**: Chrome 90+ 和 Safari 14+ 各一台设备
- **测试步骤**:
  1. Chrome 用户创建会议
  2. Safari 用户加入会议
  3. 进行双向音视频通话
- **预期结果**:
  - 音视频连接成功建立
  - 双向音视频通话正常
  - 无明显兼容性问题
- **优先级**: P0

#### TC-031: Chrome ↔ Firefox 互通
- **测试目标**: 验证 Chrome 和 Firefox 之间的音视频互通
- **前置条件**: Chrome 90+ 和 Firefox 88+ 各一台设备
- **测试步骤**:
  1. Chrome 用户创建会议
  2. Firefox 用户加入会议
  3. 进行双向音视频通话
- **预期结果**:
  - 音视频连接成功建立
  - 双向音视频通话正常
  - VP8 编码器兼容性良好
- **优先级**: P0

#### TC-032: Safari ↔ Firefox 互通
- **测试目标**: 验证 Safari 和 Firefox 之间的音视频互通
- **前置条件**: Safari 14+ 和 Firefox 88+ 各一台设备
- **测试步骤**:
  1. Safari 用户创建会议
  2. Firefox 用户加入会议
  3. 进行双向音视频通话
- **预期结果**:
  - 音视频连接成功建立
  - H.264 编码器兼容性良好
  - 双向通话正常
- **优先级**: P0

### 5.2 Web 端与 Electron 互通

#### TC-033: Web Chrome ↔ Electron 互通
- **测试目标**: 验证 Web Chrome 和 Electron 桌面端的互通
- **前置条件**: Chrome 浏览器和 Electron 桌面客户端
- **测试步骤**:
  1. Web Chrome 用户创建会议
  2. Electron 用户加入会议
  3. 进行双向音视频通话
- **预期结果**:
  - 音视频连接成功建立
  - 双向通话质量良好
  - 无明显平台差异
- **优先级**: P0

#### TC-034: Web Safari ↔ Electron 互通
- **测试目标**: 验证 Web Safari 和 Electron 桌面端的互通
- **前置条件**: Safari 浏览器和 Electron 桌面客户端
- **测试步骤**:
  1. Web Safari 用户创建会议
  2. Electron 用户加入会议
  3. 进行双向音视频通话
- **预期结果**:
  - 音视频连接成功建立
  - H.264 编码器兼容性良好
  - 通话质量达标
- **优先级**: P0

### 5.3 浏览器特有功能测试

#### TC-035: Safari Simulcast 支持验证
- **测试目标**: 验证 Safari 对 Simulcast 的支持程度
- **前置条件**: Safari 14+ 浏览器
- **测试步骤**:
  1. Safari 用户发布 Simulcast 视频流
  2. 观察 Simulcast 层上传情况
  3. 其他浏览器订阅 Safari 的视频流
- **预期结果**:
  - Safari 可能只支持单层上传（备选方案）
  - 其他浏览器能正常接收 Safari 的视频流
  - 通话基本可用
- **优先级**: P0

#### TC-036: Firefox H.264 许可证验证
- **测试目标**: 验证 Firefox 的 H.264 编码器可用性
- **前置条件**: Firefox 88+ 浏览器
- **测试步骤**:
  1. Firefox 用户发布 H.264 编码的视频流
  2. 观察编码器选择情况
  3. 验证与其他浏览器的兼容性
- **预期结果**:
  - Firefox 优先使用 VP8，H.264 作为备选
  - 与其他浏览器互通正常
- **优先级**: P0

#### TC-037: 浏览器 autoplay 策略验证
- **测试目标**: 验证各浏览器 autoplay 策略对音频播放的影响
- **前置条件**: 各主流浏览器
- **测试步骤**:
  1. 新标签页直接打开会议页面
  2. 加入会议，观察远端音频播放情况
  3. 测试用户交互后的音频恢复
- **预期结果**:
  - 部分浏览器可能需要用户交互后才能播放音频
  - UI 应有明确的音频播放引导提示
  - 用户点击后音频正常播放
- **优先级**: P0

---

## 6. 性能指标验证测试用例

### 6.1 延迟性能测试

#### TC-038: 端到端音视频延迟测量
- **测试目标**: 验证 LAN 环境下端到端延迟 < 300ms
- **前置条件**: 两台设备在同一局域网
- **测试步骤**:
  1. 使用 WebRTC stats API 测量 RTP 时间戳
  2. 计算端到端延迟（发送时间 - 接收时间）
  3. 多次测量取 P95 值
- **预期结果**:
  - 端到端延迟 P95 < 300ms
  - 音频延迟 < 200ms
  - 视频延迟 < 300ms
- **优先级**: P0

#### TC-039: 连接建立时间测量
- **测试目标**: 验证连接建立时间 < 3s
- **前置条件**: 用户进入会议页面
- **测试步骤**:
  1. 记录页面加载到首帧渲染的时间
  2. 测量完整 WebRTC 连接建立时间
- **预期结果**:
  - 连接建立时间 < 3s（LAN）
  - 首帧渲染时间 < 1s
- **优先级**: P0

### 6.2 视频质量测试

#### TC-040: 720p@30fps 视频质量验证
- **测试目标**: 验证良好网络下视频达到 720p@30fps
- **前置条件**: 网络带宽 > 1500kbps
- **测试步骤**:
  1. 发布 1280x720 视频流
  2. 使用 WebRTC stats 监控分辨率、帧率、码率
- **预期结果**:
  - 视频分辨率稳定在 1280x720
  - 帧率 ≥ 30fps
  - 码率在 1-2Mbps 范围内
- **优先级**: P0

#### TC-041: 视频流畅度验证
- **测试目标**: 验证视频播放的流畅度
- **前置条件**: 正常视频通话进行中
- **测试步骤**:
  1. 监控视频帧率稳定性
  2. 观察有无明显卡顿
  3. 测量卡顿率（丢帧率）
- **预期结果**:
  - 帧率波动 < 10%
  - 卡顿率 < 1%
  - 无明显画面冻结
- **优先级**: P0

### 6.3 音频质量测试

#### TC-042: 音频清晰度验证
- **测试目标**: 验证音频通话的清晰度
- **前置条件**: 正常音频通话进行中
- **测试步骤**:
  1. 进行语音通话测试
  2. 评估语音清晰度、背景噪音
  3. 测试回声消除效果
- **预期结果**:
  - 语音清晰可辨
  - 无明显背景噪音
  - 无回声问题
- **优先级**: P0

#### TC-043: 音频延迟同步验证
- **测试目标**: 验证音视频同步效果
- **前置条件**: 正常音视频通话进行中
- **测试步骤**:
  1. 说话同时做手势动作
  2. 观察音视频同步情况
  3. 测量音视频同步误差
- **预期结果**:
  - 音视频同步误差 < 100ms
  - 唇音同步良好
- **优先级**: P0

### 6.4 资源使用测试

#### TC-044: CPU 和内存使用监控
- **测试目标**: 验证音视频通话的资源使用效率
- **前置条件**: 4 人音视频通话进行中
- **测试步骤**:
  1. 监控浏览器进程的 CPU 使用率
  2. 监控内存使用情况
  3. 观察 30 分钟长期通话的稳定性
- **预期结果**:
  - CPU 使用率 < 80%
  - 内存使用稳定，无持续增长
  - 30 分钟通话无崩溃或明显性能下降
- **优先级**: P0

---

## 7. 边界条件与错误处理测试用例

### 7.1 权限相关边界测试

#### TC-045: 同时拒绝摄像头和麦克风权限
- **测试目标**: 验证用户同时拒绝两个权限时的处理
- **前置条件**: 用户访问会议页面
- **测试步骤**:
  1. 用户同时拒绝摄像头和麦克风权限
  2. 观察入会流程
- **预期结果**:
  - 允许进入会议（纯观看模式）
  - 显示"无法发布自己的媒体"提示
  - 可以正常观看和收听其他参会者
- **优先级**: P1

#### TC-046: 设备被占用处理
- **测试目标**: 验证设备被其他程序占用时的处理
- **前置条件**: 摄像头/麦克风被其他应用占用
- **测试步骤**:
  1. 尝试获取媒体设备
  2. 观察错误处理
- **预期结果**:
  - 返回 NotReadableError
  - 显示"设备被其他程序占用"提示
  - 引导用户关闭占用程序后重试
- **优先级**: P1

### 7.2 网络相关边界测试

#### TC-047: 长时间网络中断处理
- **测试目标**: 验证长时间网络中断后的清理机制
- **前置条件**: 正常音视频通话进行中
- **测试步骤**:
  1. 模拟网络中断超过 30 秒
  2. 观察服务端的清理机制
- **预期结果**:
  - 服务端在超时后清理该用户的 Producer/Consumer
  - 向其他参会者广播 `rtc:peerLeft` 事件
  - 客户端显示"连接已断开"提示
- **优先级**: P1

#### TC-048: 页面刷新后的重连
- **测试目标**: 验证页面刷新后的自动重连机制
- **前置条件**: 正常音视频通话进行中
- **测试步骤**:
  1. 刷新浏览器页面
  2. 观察自动重连行为
- **预期结果**:
  - 页面重新加载后自动尝试重连
  - 重连成功后恢复之前的订阅状态
  - 媒体流自动恢复
- **优先级**: P1

### 7.3 会议生命周期边界

#### TC-049: 会议结束后尝试加入信令
- **测试目标**: 验证会议结束后信令服务的拒绝机制
- **前置条件**: 会议已通过 REQ-002 API 结束
- **测试步骤**:
  1. 用户尝试加入已结束会议的信令房间
  2. 观察信令服务响应
- **预期结果**:
  - 信令服务拒绝连接
  - 返回错误码 41001（会议已结束）
  - 客户端跳转到会议结束页面
- **优先级**: P1

#### TC-050: 未加入会议直接连接信令
- **测试目标**: 验证未通过 REQ-002 加入会议的用户连接信令的处理
- **前置条件**: 用户未调用加入会议 API
- **测试步骤**:
  1. 直接连接 WebSocket 信令服务
  2. 发送 `rtc:join` 信令
- **预期结果**:
  - 信令服务验证用户未加入会议
  - 返回错误码 40301（无权限访问该会议）
  - 连接被拒绝
- **优先级**: P1

#### TC-051: 信令消息限流验证
- **测试目标**: 验证信令消息限流机制的有效性
- **前置条件**: 正常音视频连接建立
- **测试步骤**:
  1. 快速发送大量信令消息（>10条/秒）
  2. 观察限流机制
- **预期结果**:
  - 超出限流阈值后消息被拒绝
  - 返回适当的限流错误提示
  - 防止信令洪泛攻击
- **优先级**: P1

---

## 测试工具与环境要求

### 测试工具清单

| 工具 | 版本要求 | 用途 |
|------|---------|------|
| Jest | 29.7.0+ | 单元测试、集成测试框架 |
| Supertest | 6.3.3+ | API 集成测试 HTTP 客户端 |
| Playwright | 1.40.0+ | E2E 测试框架（多浏览器支持） |
| mediasoup-client | 3.6.0+ | WebRTC 客户端测试 |
| tc (netem) | - | 网络模拟（丢包、抖动、带宽限制） |
| WebRTC internals | - | WebRTC 连接状态和统计信息监控 |
| k6 | 0.45.0+ | 性能压力测试 |

### 测试环境配置

| 环境类型 | 配置要求 | 用途 |
|---------|---------|------|
| 开发环境 | Node.js 20.x, PostgreSQL 15, Redis 7 | 单元测试、集成测试 |
| 测试环境 | Docker 容器化部署 | E2E 测试、性能测试 |
| 网络环境 | 局域网（LAN） | 延迟性能测试 |
| 浏览器矩阵 | Chrome 90+, Safari 14+, Firefox 88+ | 兼容性测试 |

### 测试数据准备

1. **测试用户账户**: 准备 5 个测试用户账户
2. **测试会议**: 准备多个测试会议，包含不同状态（进行中、已结束）
3. **媒体设备**: 准备摄像头、麦克风等测试设备
4. **网络模拟**: 准备网络模拟工具和配置

---

## 测试执行计划

### 第一阶段：单元测试（后端 + 前端）
- **时间**: 第 1 周
- **目标**: 完成所有模块的单元测试，覆盖率 > 80%
- **负责人**: 后端开发团队、前端开发团队

### 第二阶段：集成测试
- **时间**: 第 2 周
- **目标**: 完成 API 集成测试和信令集成测试
- **负责人**: 测试团队

### 第三阶段：E2E 功能测试
- **时间**: 第 3 周
- **目标**: 完成端到端功能测试，覆盖所有用户故事
- **负责人**: 测试团队

### 第四阶段：性能与兼容性测试
- **时间**: 第 4 周
- **目标**: 完成性能测试、弱网测试、跨浏览器测试
- **负责人**: 测试团队

### 第五阶段：验收测试
- **时间**: 第 5 周
- **目标**: 最终验收测试，验证所有验收标准
- **负责人**: 产品经理、测试负责人

---

## 风险评估与应对措施

### 技术风险
- **风险**: Safari 对 Simulcast 支持不完整
- **应对**: 准备降级方案，使用单层传输

### 进度风险
- **风险**: 弱网测试环境搭建复杂
- **应对**: 提前准备网络模拟工具和配置

### 质量风险
- **风险**: 跨浏览器兼容性问题
- **应对**: 尽早开展兼容性测试，问题提前暴露

---

**文档版本**: v1.0
**创建日期**: 2026-02-26
**最后更新**: 2026-02-26
**维护人**: test-leader