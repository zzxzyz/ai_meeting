# REQ-004 音视频控制功能 - 需求分析

## 文档信息

- **需求编号**: REQ-004
- **需求名称**: 音视频控制功能
- **文档类型**: 需求分析
- **版本**: v1.0
- **创建日期**: 2026-02-26
- **负责人**: product-manager
- **状态**: 草稿（待完善）
- **依赖**: REQ-003 实时音视频通话（已完成）

---

## 1. 需求背景与业务目标

### 1.1 业务背景

在 REQ-003 实现的基础音视频通话能力之上，用户需要能够灵活控制自己的音视频设备状态，以应对不同会议场景：

- **隐私保护**：临时关闭摄像头/麦克风
- **网络优化**：弱网环境下优先保障音频质量
- **会议礼仪**：发言时开启麦克风，聆听时静音
- **设备管理**：多设备切换和状态管理

### 1.2 业务目标

1. **基础控制能力**：提供麦克风静音/取消静音、摄像头开启/关闭功能
2. **状态实时同步**：用户操作后状态立即同步给其他参会者
3. **设备状态持久化**：会议期间保持用户选择的设备状态
4. **跨端一致性**：Web 端与 Electron 端控制体验一致
5. **弱网适应性**：控制指令在弱网环境下仍能可靠执行

### 1.3 依赖说明

- **REQ-003（已完成）**：
  - mediasoup SFU 架构提供 Producer pause/resume 机制
  - WebSocket 信令通道用于状态同步
  - 设备权限管理和媒体流采集能力
  - 会议房间和参与者管理机制

- **REQ-004 为后续需求提供基础**：
  - REQ-005 屏幕共享：复用设备控制界面和状态同步机制
  - REQ-008 虚拟背景：基于摄像头控制状态进行背景切换

---

## 2. 用户故事（User Stories）

### US-001：静音/取消静音麦克风

> 作为**会议参与者**，我希望**能够快速静音或取消静音我的麦克风**，以便**在需要发言时开启麦克风，聆听时保持静音**。

**验收条件**：
- 点击麦克风按钮可切换静音状态
- 静音后本地麦克风图标显示静音状态（🔇）
- 其他参会者看到我的静音状态指示
- 静音状态下，其他参会者听不到我的声音
- 取消静音后，声音立即恢复传输
- 状态变化延迟 < 100ms

### US-002：开启/关闭摄像头

> 作为**会议参与者**，我希望**能够控制摄像头的开启和关闭**，以便**在需要展示视频时开启，保护隐私时关闭**。

**验收条件**：
- 点击摄像头按钮可切换开启/关闭状态
- 摄像头关闭时，本地预览显示头像或昵称占位
- 其他参会者看到我的摄像头关闭状态指示（🎥✕）
- 摄像头关闭后，其他参会者看不到我的视频画面
- 重新开启摄像头后，视频流立即恢复
- 状态变化延迟 < 100ms

### US-003：查看其他参会者状态

> 作为**会议参与者**，我希望**能够实时看到其他参会者的音视频状态**，以便**了解谁在发言、谁关闭了摄像头**。

**验收条件**：
- 每个参会者视频格上显示当前音视频状态图标
- 静音状态显示 🔇 图标
- 摄像头关闭状态显示 🎥✕ 图标
- 网络质量显示信号格指示器
- 状态变化实时更新，延迟 < 200ms

### US-004：设备热插拔处理

> 作为**使用外接设备的用户**，我希望**在插拔摄像头或麦克风时，系统能自动识别并更新可用设备列表**，以便**快速切换到新设备**。

**验收条件**：
- 插入新设备时，设备列表自动更新
- 拔出当前使用设备时，自动切换到其他可用设备
- 设备切换过程中保持静音/摄像头关闭状态
- 切换完成后显示新设备名称

### US-005：默认入会状态配置

> 作为**经常参会的用户**，我希望**能够设置默认的入会音视频状态**，以便**每次进入会议时自动应用我的偏好设置**。

**验收条件**：
- 用户设置中可配置默认麦克风状态（开启/静音）
- 用户设置中可配置默认摄像头状态（开启/关闭）
- 新会议中自动应用用户设置的默认状态
- 状态配置在用户账号级别持久化

---

## 3. 功能点详细描述

### 3.1 麦克风控制功能

#### 3.1.1 静音/取消静音操作

**前端实现**：
- 麦克风按钮位于底部控制栏左侧
- 点击按钮切换静音状态
- 状态变化通过 CSS 动画提供视觉反馈
- 静音状态：红色静音图标 + 按钮红色边框
- 非静音状态：正常麦克风图标

**后端实现**：
- 使用 mediasoup Producer.pause()/resume() 方法
- 静音：暂停音频 Producer，停止发送音频包
- 取消静音：恢复音频 Producer，继续发送音频包

**信令流程**：
```
客户端点击静音按钮
    ↓
前端调用 Producer.pause()
    ↓
发送 rtc:producerPaused 信令给服务端
    ↓
服务端广播 rtc:producerPaused 给其他客户端
    ↓
其他客户端更新该用户的静音状态显示
```

#### 3.1.2 静音状态同步

**状态指示器**：
- 本地：底部控制栏麦克风按钮状态变化
- 远端：每个参会者视频格右上角显示静音图标
- 颜色：静音状态红色，正常状态白色

### 3.2 摄像头控制功能

#### 3.2.1 开启/关闭操作

**前端实现**：
- 摄像头按钮位于底部控制栏麦克风按钮右侧
- 点击按钮切换摄像头状态
- 关闭摄像头时，本地预览显示用户头像/昵称
- 重新开启时，恢复视频流采集

**后端实现**：
- 关闭摄像头：暂停视频 Producer
- 开启摄像头：恢复视频 Producer
- 使用 Simulcast 三层编码，关闭时停止所有层

**信令流程**：
```
客户端点击摄像头按钮
    ↓
前端调用 Producer.pause()/resume()
    ↓
发送 rtc:producerPaused/resumed 信令
    ↓
服务端广播状态变化给其他客户端
    ↓
其他客户端更新摄像头状态显示
```

#### 3.2.2 摄像头关闭时的占位显示

**占位方案**：
- 显示用户头像（如果已上传）
- 或显示用户昵称首字母的彩色圆形
- 背景色根据用户 ID 哈希生成
- 保持 16:9 宽高比，与视频格一致

### 3.3 状态同步机制

#### 3.3.1 实时状态同步

**同步策略**：
- 使用 WebSocket 信令实时广播状态变化
- 服务端维护每个 Producer 的暂停状态
- 新用户加入时，服务端推送当前房间状态
- 状态变化延迟目标 < 100ms

**容错机制**：
- 信令丢失时，客户端通过定期状态同步恢复
- 网络中断重连后，自动同步最新状态

#### 3.3.2 状态一致性保障

**冲突解决**：
- 以服务端状态为准
- 客户端状态与服务端不一致时，以服务端为准
- 定期状态同步防止长时间不一致

### 3.4 设备管理功能

#### 3.4.1 设备枚举与切换

**设备发现**：
- 使用 `navigator.mediaDevices.enumerateDevices()`
- 监听 `devicechange` 事件处理热插拔
- 设备标签本地化存储，避免权限提示

**设备切换**：
- 设备下拉菜单显示所有可用设备
- 切换设备时保持当前静音/摄像头状态
- 切换过程平滑，无闪烁或中断

#### 3.4.2 默认设备设置

**持久化存储**：
- 用户选择的设备 ID 存储到 localStorage
- 下次会议自动使用上次选择的设备
- 设备不可用时，自动回退到默认设备

---

## 4. 非功能性需求

### 4.1 性能需求

| 指标 | 目标值 | 可接受值 | 不可接受 |
|------|--------|---------|---------|
| 控制操作延迟 | < 50ms | < 100ms | > 200ms |
| 状态同步延迟 | < 100ms | < 200ms | > 500ms |
| 设备枚举时间 | < 300ms | < 500ms | > 1000ms |
| 设备切换时间 | < 500ms | < 1000ms | > 2000ms |

### 4.2 可靠性需求

- **控制指令可靠性**：99.9% 的控制指令成功执行
- **状态同步可靠性**：99.9% 的状态变化正确同步
- **设备热插拔**：95% 的热插拔事件正确处理
- **弱网适应性**：20% 丢包率下控制功能仍可用

### 4.3 兼容性需求

**浏览器支持**：
- Chrome 90+：完整支持
- Safari 14+：基本支持（设备枚举可能受限）
- Firefox 88+：完整支持
- Edge 90+：完整支持（Chromium 内核）

**桌面端支持**：
- Electron：Windows 10+, macOS 11+
- 设备权限处理使用系统级 API

### 4.4 安全需求

- **权限控制**：只有设备所有者可以控制自己的设备
- **状态验证**：服务端验证控制指令的合法性
- **信令加密**：WebSocket 信令通过 TLS 加密

---

## 5. 用户界面设计要点

### 5.1 控制栏布局

**底部控制栏**（参考 REQ-003 UI/UX 设计）：
```
┌────────────────────────────────────────────────────────────┐
│           [🔊]    [📷]    [📞 结束通话]                    │
│          麦克风    摄像头     结束通话                     │
└────────────────────────────────────────────────────────────┘
```

**状态指示**：
- 麦克风静音：红色图标 + 红色边框
- 摄像头关闭：带斜杠图标 + 灰色边框
- 正常状态：白色图标 + 透明边框

### 5.2 视频格状态叠加

**每个参会者视频格**：
```
┌──────────────────────────────┐
│                              │
│         [视频流/占位]         │
│                              │
│  昵称                 [状态图标] │
└──────────────────────────────┘
```

**状态图标位置**：右上角
- 静音：🔇（红色）
- 摄像头关闭：🎥✕（灰色）
- 网络质量：📶（绿/黄/红）

### 5.3 设备选择菜单

**下拉菜单设计**：
- 点击设备图标展开下拉菜单
- 显示所有可用设备列表
- 当前设备高亮显示
- 设备名称截断处理（过长时显示省略号）

---

## 6. 数据模型设计

### 6.1 前端状态管理

**本地状态**：
```typescript
interface LocalDeviceState {
  audio: {
    muted: boolean;           // 是否静音
    deviceId: string;         // 当前音频设备 ID
    availableDevices: MediaDeviceInfo[]; // 可用音频设备列表
  };
  video: {
    enabled: boolean;         // 摄像头是否开启
    deviceId: string;         // 当前视频设备 ID
    availableDevices: MediaDeviceInfo[]; // 可用视频设备列表
  };
}
```

**远端状态**：
```typescript
interface RemotePeerState {
  peerId: string;
  audio: {
    muted: boolean;           // 远端静音状态
  };
  video: {
    enabled: boolean;         // 远端摄像头状态
  };
  networkQuality: 'good' | 'medium' | 'poor'; // 网络质量
}
```

### 6.2 服务端状态存储

**内存状态**（不持久化）：
```typescript
interface ProducerState {
  producerId: string;
  peerId: string;
  kind: 'audio' | 'video';
  paused: boolean;           // 是否暂停（对应静音/关闭）
  pausedAt?: Date;           // 暂停时间
}
```

---

## 7. 错误处理与边界情况

### 7.1 错误场景处理

| 场景 | 处理方式 | 用户提示 |
|------|---------|---------|
| 控制指令发送失败 | 自动重试 3 次 | "操作失败，请重试" |
| 设备不可用 | 自动切换到其他可用设备 | "设备不可用，已切换到默认设备" |
| 权限被拒绝 | 引导用户开启权限 | "需要麦克风权限才能取消静音" |
| 网络中断 | 缓存指令，网络恢复后执行 | "网络连接已恢复" |

### 7.2 边界情况

**首次入会**：
- 应用用户设置的默认状态
- 如无设置，默认开启麦克风和摄像头

**设备热插拔**：
- 当前使用设备拔出时，自动切换到其他设备
- 新设备插入时，更新设备列表但不自动切换

**权限变化**：
- 权限被撤销时，自动关闭对应功能
- 权限重新授予时，恢复之前状态

---

## 8. 验收测试用例

### 8.1 功能测试

**麦克风控制测试**：
- [ ] 点击静音按钮，本地图标变为静音状态
- [ ] 静音后，其他参会者听不到声音
- [ ] 取消静音后，声音立即恢复
- [ ] 状态同步延迟 < 100ms

**摄像头控制测试**：
- [ ] 点击关闭摄像头，本地预览显示占位
- [ ] 关闭后，其他参会者看不到视频
- [ ] 重新开启后，视频立即恢复
- [ ] 状态同步延迟 < 100ms

### 8.2 性能测试

**弱网测试**：
- [ ] 20% 丢包率下，控制指令仍能执行
- [ ] 网络恢复后，状态自动同步
- [ ] 高延迟下，操作反馈仍然及时

**压力测试**：
- [ ] 4 人同时频繁操作控制功能
- [ ] 长时间会议中控制功能稳定性

### 8.3 兼容性测试

**跨浏览器测试**：
- [ ] Chrome 90+：所有功能正常
- [ ] Safari 14+：基本功能正常
- [ ] Firefox 88+：所有功能正常
- [ ] Edge 90+：所有功能正常

**桌面端测试**：
- [ ] Electron Windows：设备热插拔正常
- [ ] Electron macOS：权限处理正常

---

## 9. 后续版本规划

### v0.2 增强功能

- **高级设备设置**：音频输入/输出设备独立设置
- **状态快捷键**：键盘快捷键快速切换状态
- **状态记忆**：记住每个会议的设备状态

### v0.3 高级功能

- **语音激活**：检测到说话时自动取消静音
- **智能状态**：根据网络质量自动调整状态
- **状态广播**：主持人可广播状态指令

---

## 10. 参考资料

- [REQ-003 技术方案](../REQ-003/tech_research.md)
- [REQ-003 API 契约](../REQ-003/api_contract.md)
- [mediasoup Producer API 文档](https://mediasoup.org/documentation/v3/mediasoup/api/#Producer)
- [WebRTC 设备管理 API](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices)

---

**文档状态**: 草稿（待 product-manager 完善）
**下一步**: UI/UX 设计阶段（Task #108）