# 音视频架构设计

## 1. 背景与目标

### 1.1 业务背景
构建一个开源的视频会议系统，支持多人实时音视频通信，需要在性能、成本、可扩展性之间取得平衡。

### 1.2 技术目标
- **低延迟**：端到端延迟 < 300ms
- **高质量**：支持 1080p 视频、高清音频
- **弱网对抗**：在 10% 丢包率下仍可正常通话
- **可扩展**：单房间支持 50+ 参会者
- **跨平台**：Web、iOS、Android、Windows、macOS、Linux

### 1.3 约束条件
- MVP 阶段：优先 Web 端，快速验证
- 开源生态：优先选择成熟的开源方案
- 成本控制：初期使用开源免费方案，预留商业化升级路径

---

## 2. 方案调研

### 2.1 媒体服务器架构

#### 2.1.1 SFU (Selective Forwarding Unit)

**原理**：服务器选择性转发媒体流，不做转码混流

**优势**：
- 延迟低（<200ms）
- 服务器负载低（只转发不处理）
- 支持 Simulcast 和 SVC，灵活适配不同网络条件
- 易于水平扩展

**劣势**：
- 客户端需处理多路流（N-1 路下行）
- 客户端性能要求高
- 带宽消耗较大（多路上下行）

**适用场景**：
- 小型会议（<20 人）
- 对延迟敏感的场景
- 参会者网络条件较好

#### 2.1.2 MCU (Multipoint Control Unit)

**原理**：服务器解码、混流、编码，输出单路流

**优势**：
- 客户端负载低（只处理 1 路流）
- 带宽消耗低（单路上下行）
- 兼容性好（不依赖客户端能力）

**劣势**：
- 延迟高（300-500ms，需转码）
- 服务器负载高（CPU 密集）
- 扩展成本高（硬件编码器昂贵）
- 灵活性差（固定布局）

**适用场景**：
- 大型会议（>50 人）
- 客户端性能弱
- 录制与直播场景

#### 2.1.3 混合架构 (SFU + MCU)

**原理**：SFU 处理实时通信，MCU 处理录制和大规模广播

**优势**：
- 兼顾低延迟与可扩展性
- 灵活应对不同场景

**劣势**：
- 架构复杂度高
- 运维成本高

#### 2.1.4 方案对比表

| 维度 | SFU | MCU | 混合 |
|------|-----|-----|------|
| 延迟 | <200ms | 300-500ms | <200ms（实时）|
| 服务器 CPU | 低（5%） | 高（80%+） | 中 |
| 带宽消耗 | 高（N-1 路） | 低（1 路） | 中 |
| 扩展性 | 优秀（水平扩展） | 一般（垂直扩展） | 优秀 |
| 客户端要求 | 高 | 低 | 高 |
| 开发复杂度 | 中 | 高 | 高 |
| 成本（100人在线） | $50/月 | $300/月 | $150/月 |

---

### 2.2 开源媒体服务器选型

#### 2.2.1 mediasoup

**技术栈**：Node.js + C++ (libwebrtc)

**特性**：
- 成熟的 SFU 实现
- 支持 Simulcast、SVC、E2E 加密
- 高性能（单核处理 500+ 流）
- 官方文档完善，社区活跃

**优势**：
- WebRTC 标准兼容性最好
- TypeScript 友好，易于集成
- 灵活的 API 设计
- 商业案例多（Discord、Whereby）

**劣势**：
- 仅支持 Node.js 后端
- 需要理解 WebRTC 底层概念

#### 2.2.2 Janus Gateway

**技术栈**：C 语言

**特性**：
- 插件化架构（SFU、MCU、录制、流媒体）
- 支持 SIP、RTSP、WebRTC
- 轻量级，性能极高

**优势**：
- 功能全面，一站式解决方案
- 性能卓越（C 实现）
- 协议支持广泛

**劣势**：
- C 语言开发门槛高
- 插件开发复杂
- 官方文档偏底层

#### 2.2.3 Pion (Go)

**技术栈**：Go 语言

**特性**：
- 纯 Go 实现的 WebRTC 库
- 云原生友好（Kubernetes 部署）
- 灵活的 API

**优势**：
- Go 生态，易于维护
- 轻量级，无外部依赖
- 适合微服务架构

**劣势**：
- 社区相对较小
- 功能相对基础，需自行封装
- 商业案例较少

#### 2.2.4 Kurento (已停止维护)

**技术栈**：Java + C++ (GStreamer)

**特性**：
- MCU 架构
- 支持录制、转码、计算机视觉

**劣势**：
- 2022 年停止维护
- 不推荐使用

#### 2.2.5 开源方案对比表

| 维度 | mediasoup | Janus | Pion |
|------|-----------|-------|------|
| 成熟度 | ★★★★★ | ★★★★☆ | ★★★☆☆ |
| 性能 | ★★★★☆ | ★★★★★ | ★★★★☆ |
| 易用性 | ★★★★☆ | ★★★☆☆ | ★★★★☆ |
| 社区活跃度 | ★★★★★ | ★★★★☆ | ★★★☆☆ |
| 文档质量 | ★★★★★ | ★★★☆☆ | ★★★★☆ |
| 扩展性 | ★★★★★ | ★★★★☆ | ★★★★★ |
| 学习曲线 | 中 | 高 | 中 |
| 商业案例 | 多 | 中 | 少 |

---

### 2.3 信令协议

#### 2.3.1 自定义 JSON over WebSocket

**优势**：
- 灵活，可按需扩展
- 易于调试
- 易于与 Web 集成

**劣势**：
- 需自行设计协议
- 兼容性需自行保障

#### 2.3.2 SIP (Session Initiation Protocol)

**优势**：
- 电信级标准协议
- 与传统电话系统互通
- 生态成熟

**劣势**：
- 协议复杂，学习曲线陡峭
- 对 Web 不友好
- 过度设计（对简单会议场景）

#### 2.3.3 选型结论

**MVP 推荐**：自定义 JSON over WebSocket
- 简单快速，满足核心需求
- 易于与 Web 框架集成
- 预留与 SIP 网关对接能力

---

### 2.4 编解码器

#### 2.4.1 视频编解码器

| 编解码器 | 压缩率 | CPU 消耗 | 浏览器支持 | 硬件加速 |
|---------|--------|----------|-----------|---------|
| **H.264** | 中 | 低 | ★★★★★ | ★★★★★ |
| **VP8** | 中 | 中 | ★★★★★ | ★★★☆☆ |
| **VP9** | 高 | 高 | ★★★★☆ | ★★★☆☆ |
| **H.265** | 高 | 中 | ★★☆☆☆ | ★★★★☆ |
| **AV1** | 最高 | 极高 | ★★☆☆☆ | ★☆☆☆☆ |

**选型决策**：
- **主编解码器**：H.264 Baseline/Main Profile
  - 兼容性最好（所有浏览器、移动端）
  - 硬件加速成熟（降低功耗）
  - 专利费用已成熟（OpenH264 免费实现）
- **备选方案**：VP8（Chrome 默认，开源免费）

#### 2.4.2 音频编解码器

| 编解码器 | 码率 | 质量 | 浏览器支持 | 延迟 |
|---------|-----|------|-----------|------|
| **Opus** | 6-510 kbps | 优秀 | ★★★★★ | <20ms |
| **G.711** | 64 kbps | 中 | ★★★★★ | <10ms |
| **AAC** | 128 kbps | 优秀 | ★★★★☆ | 30-50ms |

**选型决策**：
- **主编解码器**：Opus
  - WebRTC 标准，浏览器原生支持
  - 动态码率适配（6-510 kbps）
  - 低延迟（<20ms）
  - 音质优秀（优于 AAC）

---

### 2.5 自适应码率策略

#### 2.5.1 Simulcast（同时投流）

**原理**：客户端同时上传多个分辨率版本（如 180p、360p、720p），服务器根据订阅者网络条件选择合适版本转发

**优势**：
- 灵活适配不同网络条件
- 服务器无需转码（低延迟）
- 画质切换流畅

**劣势**：
- 上行带宽消耗 2-3 倍
- 对上行网络要求高

#### 2.5.2 SVC (Scalable Video Coding)

**原理**：单路流包含多层编码（时间层、空间层、质量层），服务器可丢弃高层数据降低码率

**优势**：
- 上行带宽节省（仅 1 路流）
- 平滑降级

**劣势**：
- 编解码器支持有限（VP9、AV1）
- 浏览器支持不完善
- 延迟略高

#### 2.5.3 选型决策

**MVP 推荐**：Simulcast (H.264)
- 浏览器支持成熟
- mediasoup 官方支持
- 适配多种网络场景

**演进路线**：VP9 SVC（待浏览器支持成熟）

---

### 2.6 弱网对抗策略

#### 2.6.1 前向纠错 (FEC)

**原理**：发送冗余数据包，接收端可用冗余包恢复丢失包

**优势**：
- 无需重传，延迟低
- 适合单向通信

**劣势**：
- 增加 10-30% 带宽
- 高丢包率下效果有限

#### 2.6.2 重传 (NACK)

**原理**：接收端检测丢包后请求重传

**优势**：
- 带宽效率高
- 可靠性高

**劣势**：
- 增加延迟（RTT 级别）

#### 2.6.3 抖动缓冲区 (Jitter Buffer)

**原理**：接收端缓冲一定时间的数据包，平滑网络抖动

**配置**：
- 最小延迟：20ms
- 最大延迟：200ms
- 动态调整策略

#### 2.6.4 拥塞控制

**算法**：GCC (Google Congestion Control)
- 基于延迟和丢包率估算带宽
- 动态调整发送码率
- WebRTC 内置实现

#### 2.6.5 综合策略

```
低丢包率（<1%）：无特殊处理
中丢包率（1-5%）：NACK + 动态码率
高丢包率（5-10%）：NACK + FEC + 降低分辨率
极高丢包率（>10%）：音频优先，视频降级到最低分辨率或关闭
```

---

## 3. 选型决策

### 3.1 MVP 推荐方案

#### 3.1.1 架构选型
- **媒体服务器架构**：SFU
- **开源实现**：mediasoup
- **信令协议**：JSON over WebSocket

#### 3.1.2 编解码器选型
- **视频**：H.264 Baseline/Main Profile
- **音频**：Opus
- **自适应码率**：Simulcast (3 层：180p、360p、720p)

#### 3.1.3 选择理由

**mediasoup 选择理由**：
1. **成熟度最高**：Discord、Whereby 等商业产品验证
2. **文档完善**：官方提供详细文档和 Demo
3. **TypeScript 生态**：与现代 Web 后端无缝集成
4. **性能优秀**：单核处理 500+ 流，满足初期需求
5. **活跃社区**：问题响应快，长期维护有保障

**SFU 架构选择理由**：
1. **低延迟**：<200ms，满足实时通信需求
2. **成本低**：服务器只转发不转码，云服务器成本低
3. **易扩展**：水平扩展简单，可按需增加服务器
4. **MVP 快速验证**：开发复杂度适中

---

### 3.2 演进路线

#### 3.2.1 阶段 1：MVP（0-6 个月）
- **目标**：验证核心功能，支持 10 人以下小型会议
- **方案**：mediasoup SFU + H.264 + Opus
- **部署**：单机部署，手动扩容

#### 3.2.2 阶段 2：优化扩展（6-12 个月）
- **目标**：支持 50 人会议，优化弱网体验
- **升级**：
  - 集群部署（多区域）
  - 完善弱网对抗（FEC + 自适应码率）
  - 录制功能（SFU 流转 MCU 录制）
  - CDN 加速

#### 3.2.3 阶段 3：规模化（12-24 个月）
- **目标**：支持千人级大型会议、直播
- **升级**：
  - 混合架构（SFU + MCU）
  - VP9 SVC（降低带宽）
  - 边缘节点部署
  - 智能路由（根据地理位置选择节点）

---

### 3.3 风险应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| mediasoup 与现有技术栈不兼容 | 高 | MVP 阶段独立部署，通过 API 对接 |
| 浏览器 WebRTC 实现差异 | 中 | 使用 adapter.js 抹平差异，充分测试 |
| 大规模并发性能瓶颈 | 中 | 集群部署，负载均衡 |
| 开源项目停止维护 | 低 | mediasoup 商业案例多，社区活跃，风险低 |
| H.264 专利费用 | 低 | 使用 OpenH264（Cisco 资助），免费 |

---

## 4. 详细设计

### 4.1 系统架构图

```
┌─────────────┐     WebSocket      ┌──────────────────┐
│   Browser   │◄──────信令──────────┤  Signaling Server │
│  (WebRTC)   │                     │   (Node.js)       │
└─────────────┘                     └──────────────────┘
       ▲                                     │
       │                                     │ gRPC
       │ WebRTC (DTLS-SRTP)                  │
       │                                     ▼
       │                            ┌──────────────────┐
       └────────────媒体流──────────┤  Media Server     │
                                    │   (mediasoup)     │
                                    └──────────────────┘
                                             │
                                             │ 录制/转码
                                             ▼
                                    ┌──────────────────┐
                                    │  Storage/CDN     │
                                    └──────────────────┘
```

### 4.2 媒体流处理流程

#### 4.2.1 发布流程

```
1. 客户端创建 RTCPeerConnection
2. 获取本地媒体流（getUserMedia）
3. 发送 Offer SDP 到信令服务器
4. 信令服务器创建 mediasoup Producer
5. 返回 Answer SDP
6. 建立 DTLS 握手
7. 开始发送 RTP 媒体包
```

#### 4.2.2 订阅流程

```
1. 客户端请求订阅远端流
2. 信令服务器创建 mediasoup Consumer
3. 返回 Offer SDP
4. 客户端返回 Answer SDP
5. 建立 DTLS 握手
6. 开始接收 RTP 媒体包
```

### 4.3 关键技术参数

#### 4.3.1 视频参数

| 分辨率 | 帧率 | 码率 (kbps) | 适用场景 |
|--------|-----|------------|---------|
| 180p (320x180) | 15 fps | 100 | 弱网/多人会议 |
| 360p (640x360) | 24 fps | 300 | 标准会议 |
| 720p (1280x720) | 30 fps | 1500 | 高清会议 |
| 1080p (1920x1080) | 30 fps | 3000 | 屏幕共享 |

#### 4.3.2 音频参数

```yaml
codec: opus
sample_rate: 48000 Hz
channels: 2 (Stereo)
bitrate: 32 kbps (语音) / 128 kbps (音乐)
packet_duration: 20ms
FEC: enabled
DTX: enabled (语音激活检测)
```

#### 4.3.3 网络参数

```yaml
# 拥塞控制
初始码率: 300 kbps
最小码率: 100 kbps
最大码率: 5000 kbps

# Jitter Buffer
最小延迟: 20ms
目标延迟: 50ms
最大延迟: 200ms

# NACK
重传窗口: 1000ms
最大重传次数: 3

# FEC (丢包率 > 5% 时启用)
冗余率: 10-20%
```

---

## 5. 质量保障

### 5.1 性能指标

| 指标 | 目标 | 优秀 | 可接受 | 不可接受 |
|-----|------|------|--------|---------|
| 端到端延迟 | <200ms | <150ms | <300ms | >500ms |
| 视频丢包率 | <1% | <0.5% | <3% | >5% |
| 音频丢包率 | <0.5% | <0.1% | <1% | >2% |
| 卡顿率 | <1% | <0.5% | <3% | >5% |
| 首屏渲染 | <1s | <500ms | <2s | >3s |

### 5.2 可靠性指标

- **服务可用性**：99.9%（月停机 < 43 分钟）
- **故障恢复时间**：<5 分钟（自动切换备用节点）
- **数据持久性**：99.999%（录制数据冗余存储）

### 5.3 可维护性指标

- **日志完整度**：100%（所有媒体事件记录）
- **监控覆盖率**：100%（CPU、内存、带宽、流数量）
- **告警响应时间**：<5 分钟
- **问题定位时间**：<30 分钟（通过日志和监控）

---

## 6. 实施要点

### 6.1 开发顺序

1. **阶段 1**：搭建 mediasoup 开发环境（1 周）
2. **阶段 2**：实现信令服务器（2 周）
3. **阶段 3**：实现 1v1 音视频通话（2 周）
4. **阶段 4**：实现多人会议（Simulcast）（2 周）
5. **阶段 5**：弱网对抗优化（2 周）
6. **阶段 6**：监控和运维工具（2 周）

### 6.2 测试策略

#### 6.2.1 功能测试
- 1v1 通话稳定性
- 多人会议（5/10/20/50 人）
- 屏幕共享
- 设备切换（摄像头、麦克风）
- 网络切换（WiFi/4G）

#### 6.2.2 性能测试
- 压力测试（1000 并发流）
- 弱网测试（丢包、延迟、抖动）
- 长时间稳定性（24 小时不间断）

#### 6.2.3 兼容性测试
- 浏览器：Chrome、Firefox、Safari、Edge
- 操作系统：Windows、macOS、Linux、iOS、Android
- 网络：WiFi、4G、5G、有线

---

## 7. 参考资料

### 7.1 官方文档
- [mediasoup 官方文档](https://mediasoup.org/documentation/)
- [WebRTC 标准](https://www.w3.org/TR/webrtc/)
- [Opus 编解码器](https://opus-codec.org/)

### 7.2 技术博客
- [Discord 如何使用 WebRTC](https://discord.com/blog/how-discord-handles-two-and-half-million-concurrent-voice-users-using-webrtc)
- [Google WebRTC 最佳实践](https://webrtc.org/getting-started/overview)

### 7.3 开源参考
- [mediasoup-demo](https://github.com/versatica/mediasoup-demo)
- [Jitsi Meet 架构](https://jitsi.github.io/handbook/docs/architecture)

---

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|-----|------|
| SFU | Selective Forwarding Unit，选择性转发单元 |
| MCU | Multipoint Control Unit，多点控制单元 |
| Simulcast | 同时投流，客户端上传多个分辨率版本 |
| SVC | Scalable Video Coding，可伸缩视频编码 |
| FEC | Forward Error Correction，前向纠错 |
| NACK | Negative Acknowledgement，否定应答（重传） |
| RTT | Round-Trip Time，往返时延 |
| DTX | Discontinuous Transmission，非连续传输（静音检测） |

### 8.2 FAQ

**Q: 为什么选择 SFU 而不是 MCU？**
A: MVP 阶段优先低延迟和低成本，SFU 满足需求。后续可引入 MCU 支持大型会议和录制。

**Q: H.264 有专利费用吗？**
A: 使用 OpenH264（Cisco 资助）免费。商业化后需评估 H.265/VP9。

**Q: 如何保证弱网下的通话质量？**
A: 组合策略：NACK 重传 + FEC 冗余 + 动态码率 + Simulcast 多分辨率。

**Q: 单机 mediasoup 能支持多少并发？**
A: 单核约 500 流（250 人双向通信），可通过集群扩展到数千人。
