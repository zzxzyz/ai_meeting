# 系统架构设计

> **文档状态**: ✅ 已更新（2026-02-14）
> **实施状态**: 🔄 Week 1 已完成基础框架搭建
> **相关文档**: [架构决策记录](./adr.md) | [后端架构](./backend.md) | [前端架构](./frontend.md)

---

## 📋 实施状态概览

| 组件 | 状态 | 进度 | 说明 |
|------|------|------|------|
| **前端（Web）** | ✅ 已完成 | 100% | React + Vite 框架已搭建 |
| **前端（Electron）** | ✅ 已完成 | 100% | 桌面应用骨架已完成，代码复用率 80.7% |
| **后端（NestJS）** | ✅ 已完成 | 100% | DDD 分层架构已搭建，基础模块就绪 |
| **数据库（PostgreSQL）** | ✅ 已集成 | 100% | TypeORM 已配置，User/Meeting 实体已创建 |
| **缓存（Redis）** | ✅ 已集成 | 100% | Cache Manager 已配置 |
| **认证（JWT）** | 🔜 规划中 | 30% | JWT 模块已集成，认证逻辑待实现 |
| **信令服务** | 🔜 规划中 | 0% | WebSocket 网关待实现 |
| **媒体服务（mediasoup）** | 🔜 规划中 | 0% | Phase 2 实施 |
| **录制服务** | 🔜 规划中 | 0% | Phase 3 实施 |
| **监控（Prometheus）** | 🔜 规划中 | 0% | Phase 5 实施 |

### 关键决策（详见 [ADR 文档](./adr.md)）

1. ✅ **ADR-001**: PostgreSQL 14+ 作为统一数据库（已实施）
2. 🔜 **ADR-002**: Redis Pub/Sub 信令高可用方案（规划中）
3. 🔜 **ADR-003**: mediasoup + FFmpeg 录制方案（规划中）
4. ✅ **ADR-004**: Monorepo 代码复用架构（已实施，80.7% 复用率）
5. ✅ **ADR-005**: NestJS + DDD 分层架构（已实施）
6. ✅ **ADR-006**: MVP 平台范围限定为 Web + Electron（已确认）
7. 🔜 **ADR-007**: JWT 双令牌认证（规划中）

---

## 1. 背景与目标

### 1.1 业务背景
构建一个开源视频会议系统，需要支持用户管理、会议管理、实时音视频通信、录制存储等核心功能。

### 1.2 技术目标
- **高可用性**：服务可用性 99.95%（MVP 目标 99.9%）
- **可扩展性**：支持水平扩展，从 10 人到 10000 人在线
- **低耦合**：模块化架构，便于独立开发和演进
- **可维护性**：清晰的模块边界，完善的监控和日志
- **数据库统一**：PostgreSQL 14+ 作为唯一关系型数据库

### 1.3 约束条件
- MVP 阶段：采用单体或小型微服务，避免过度设计
- 技术栈：优先使用团队熟悉的技术
- 成本控制：云原生部署，按需扩容

---

## 2. 方案调研

### 2.1 架构风格选型

#### 2.1.1 单体架构 (Monolith)

**优势**：
- 开发简单，快速启动
- 调试方便，统一部署
- 事务一致性简单

**劣势**：
- 难以扩展（需整体扩容）
- 技术栈锁定
- 代码耦合度高

**适用场景**：
- MVP 快速验证
- 团队规模小（<5 人）
- 业务逻辑简单

#### 2.1.2 微服务架构 (Microservices)

**优势**：
- 独立扩展（按需扩容热点服务）
- 技术栈自由
- 团队独立开发
- 故障隔离

**劣势**：
- 复杂度高（服务治理、分布式事务）
- 运维成本高
- 调试困难（分布式追踪）

**适用场景**：
- 业务复杂，模块边界清晰
- 团队规模大（>10 人）
- 高并发场景

#### 2.1.3 混合架构 (Modular Monolith)

**优势**：
- 模块化设计，低耦合
- 单体部署，简单运维
- 可平滑演进到微服务

**劣势**：
- 需要严格的模块边界
- 仍需整体部署

---

### 2.2 服务拆分策略

#### 2.2.1 按业务领域拆分（推荐）

```
用户服务 (User Service)
  - 用户注册、登录、认证
  - 用户资料管理
  - 权限管理

会议服务 (Meeting Service)
  - 会议创建、调度
  - 参会者管理
  - 会议状态管理

信令服务 (Signaling Service)
  - WebRTC 信令交换
  - 房间管理
  - 在线状态

媒体服务 (Media Service)
  - 媒体流转发（mediasoup）
  - 录制
  - 转码

通知服务 (Notification Service)
  - 会议邀请
  - 实时消息推送
  - 邮件/短信通知
```

#### 2.2.2 按技术层拆分（不推荐）

```
API Gateway
Business Logic Layer
Data Access Layer
```

**劣势**：
- 每个功能修改需跨多个服务
- 团队协作困难

---

### 2.3 服务通信方式

#### 2.3.1 REST API

**优势**：
- 简单易用，标准化
- 工具链成熟
- 易于调试

**劣势**：
- 性能较低（HTTP/1.1）
- 不适合实时通信

**适用场景**：
- 外部 API
- 非实时业务（用户管理、会议管理）

#### 2.3.2 gRPC

**优势**：
- 高性能（HTTP/2 + Protobuf）
- 强类型，代码生成
- 支持流式通信

**劣势**：
- 调试困难（二进制协议）
- 浏览器支持有限（需 gRPC-Web）

**适用场景**：
- 服务间通信
- 高性能要求

#### 2.3.3 WebSocket

**优势**：
- 双向实时通信
- 浏览器原生支持
- 低延迟

**劣势**：
- 长连接消耗资源
- 需要心跳保活

**适用场景**：
- 信令服务
- 实时消息推送

#### 2.3.4 消息队列（Kafka/RabbitMQ）

**优势**：
- 异步解耦
- 削峰填谷
- 高吞吐

**劣势**：
- 增加复杂度
- 需要消息幂等性

**适用场景**：
- 事件驱动（会议结束 → 录制 → 转码）
- 异步任务（邮件发送、数据统计）

#### 2.3.5 方案对比表

| 维度 | REST | gRPC | WebSocket | MQ |
|-----|------|------|-----------|-----|
| 性能 | ★★★☆☆ | ★★★★★ | ★★★★☆ | ★★★★★ |
| 易用性 | ★★★★★ | ★★★☆☆ | ★★★★☆ | ★★★☆☆ |
| 实时性 | ★☆☆☆☆ | ★★★★☆ | ★★★★★ | ★★★☆☆ |
| 调试性 | ★★★★★ | ★★★☆☆ | ★★★★☆ | ★★☆☆☆ |

---

### 2.4 数据存储选型

#### 2.4.1 关系型数据库（PostgreSQL）

**适用数据**：
- 用户信息（user, profile）
- 会议信息（meeting, participant）
- 权限管理（role, permission）

**优势**：
- 强一致性
- 复杂查询支持
- 事务支持

**选型理由**：
- 开源免费，社区活跃
- 功能强大（JSON、全文搜索）
- 扩展性好（分区表、外部表）

#### 2.4.2 NoSQL 数据库（Redis）

**适用数据**：
- 会话信息（session, token）
- 在线状态（presence）
- 实时消息（pub/sub）
- 热点数据缓存

**优势**：
- 高性能（内存操作）
- 支持丰富数据结构
- 支持 pub/sub

#### 2.4.3 对象存储（MinIO / S3）

**适用数据**：
- 录制文件（MP4）
- 屏幕共享截图
- 用户头像

**优势**：
- 海量存储，低成本
- CDN 加速
- 高可用

#### 2.4.4 时序数据库（InfluxDB）

**适用数据**：
- 性能监控指标（CPU、内存、带宽）
- 媒体质量指标（延迟、丢包率、卡顿率）
- 业务指标（并发数、活跃用户）

**优势**：
- 高效存储时序数据
- 聚合查询优化
- 数据自动过期

#### 2.4.5 存储方案对比表

| 数据类型 | 存储方案 | 容量预估（1万用户） |
|---------|---------|-------------------|
| 用户信息 | PostgreSQL | <1 GB |
| 会议信息 | PostgreSQL | <10 GB |
| 会话状态 | Redis | <1 GB |
| 录制文件 | MinIO/S3 | 1 TB/月 |
| 监控数据 | InfluxDB | 10 GB/月 |

---

### 2.5 缓存策略

#### 2.5.1 本地缓存（进程内）

**适用数据**：
- 配置信息（config）
- 静态数据（地区列表）

**实现**：
- Node.js: LRU Cache
- Go: sync.Map + TTL

#### 2.5.2 分布式缓存（Redis）

**适用数据**：
- 用户信息（减少 DB 查询）
- 会议信息（高频读取）
- API 限流计数器

**缓存策略**：
```
Cache-Aside Pattern:
  1. 读请求：先查缓存，miss 则查 DB，写入缓存
  2. 写请求：先更新 DB，再删除缓存

TTL 设置：
  - 用户信息: 1 小时
  - 会议信息: 5 分钟
  - 热点数据: 10 秒
```

---

### 2.6 服务发现与负载均衡

#### 2.6.1 服务发现

**方案对比**：

| 方案 | 优势 | 劣势 |
|-----|------|------|
| **DNS** | 简单，通用 | 更新慢，无健康检查 |
| **Consul** | 健康检查，KV 存储 | 复杂度中等 |
| **Kubernetes Service** | 云原生，自动化 | 需 K8s 环境 |

**MVP 推荐**：DNS + Nginx（简单场景）
**长期方案**：Kubernetes Service

#### 2.6.2 负载均衡

**层级设计**：
```
客户端
   ↓
云负载均衡器（ALB/NLB）
   ↓
Nginx（反向代理）
   ↓
API Gateway（路由、鉴权、限流）
   ↓
后端服务
```

**策略选择**：
- REST API: 轮询（Round Robin）
- WebSocket: IP Hash（保持长连接）
- 媒体服务: 最少连接（Least Connections）

---

## 3. 选型决策

### 3.1 MVP 推荐方案

#### 3.1.1 架构风格
**模块化单体（Modular Monolith）**

**理由**：
1. 团队规模小，快速迭代
2. 模块化设计，预留微服务化空间
3. 运维简单，降低成本

**模块划分**：
```
open-meeting/
├── modules/
│   ├── user/          # 用户模块
│   ├── meeting/       # 会议模块
│   ├── signaling/     # 信令模块
│   └── notification/  # 通知模块
├── shared/
│   ├── database/      # 数据库连接
│   ├── cache/         # 缓存
│   └── messaging/     # 消息队列
└── api/               # API 网关
```

#### 3.1.2 通信方式
- **外部 API**：REST (JSON)
- **实时通信**：WebSocket
- **异步任务**：Redis Pub/Sub（轻量级 MQ）

#### 3.1.3 数据存储
- **主数据库**：PostgreSQL 14+
- **缓存**：Redis 7+
- **对象存储**：MinIO（本地）/ S3（生产）
- **监控数据**：InfluxDB 2.x

#### 3.1.4 技术栈
- **API 服务**：Node.js (NestJS) / Go (Gin)
- **信令服务**：Node.js (Express + Socket.io)
- **媒体服务**：mediasoup (Node.js)
- **前端**：React + TypeScript

---

### 3.2 演进路线

#### 3.2.1 阶段 1：MVP（0-6 个月）
- **架构**：模块化单体
- **部署**：Docker Compose，单服务器
- **数据库**：PostgreSQL 主从复制
- **目标**：支持 100 并发用户

#### 3.2.2 阶段 2：服务拆分（6-12 个月）
- **拆分服务**：媒体服务独立部署（资源密集）
- **部署**：Kubernetes，多节点
- **数据库**：读写分离
- **目标**：支持 1000 并发用户

#### 3.2.3 阶段 3：微服务化（12-24 个月）
- **完全微服务**：用户、会议、信令、媒体、通知独立服务
- **服务治理**：Istio（服务网格）
- **数据库**：分库分表
- **目标**：支持 10000+ 并发用户

---

### 3.3 风险应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 单体架构扩展瓶颈 | 中 | 模块化设计，预留拆分接口 |
| 数据库性能瓶颈 | 高 | 读写分离、索引优化、缓存 |
| 单点故障 | 高 | 主从复制、健康检查、自动切换 |
| 技术债务积累 | 中 | 代码审查、重构预留时间 |

---

## 4. 详细设计

### 4.1 系统架构图

```
┌──────────────────────────────────────────────────────────────┐
│                         Client Layer                          │
│  Web Browser  │  iOS App  │  Android App  │  Desktop App     │
└────────────┬─────────────┬────────────────┬──────────────────┘
             │             │                │
             └─────────────┴────────────────┘
                           │
                    ┌──────▼──────┐
                    │   CDN / ALB  │
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼─────┐     ┌─────▼──────┐    ┌─────▼──────┐
   │ API GW   │     │ WebSocket  │    │   Media    │
   │ (REST)   │     │ (Signaling)│    │  (WebRTC)  │
   └────┬─────┘     └─────┬──────┘    └─────┬──────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
              ┌────────────▼────────────┐
              │   Application Layer     │
              │  ┌─────────────────┐    │
              │  │  User Module    │    │
              │  │  Meeting Module │    │
              │  │  Signaling Mod  │    │
              │  │  Notify Module  │    │
              │  └─────────────────┘    │
              └────────────┬────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼─────┐     ┌─────▼──────┐    ┌─────▼──────┐
   │PostgreSQL│     │   Redis    │    │  MinIO/S3  │
   │ (Master) │     │  (Cache)   │    │ (Storage)  │
   └──────────┘     └────────────┘    └────────────┘
```

### 4.2 数据流图

#### 4.2.1 用户注册登录流程

```
客户端 → API Gateway → User Module → PostgreSQL
                           ↓
                         Redis (Session)
                           ↓
                       返回 JWT Token
```

#### 4.2.2 创建会议流程

```
客户端 → API Gateway → Meeting Module → PostgreSQL
                           ↓
                       通知服务 (邮件/推送)
```

#### 4.2.3 加入会议流程（信令流）

```
客户端 → WebSocket → Signaling Service
           ↓
      Redis (Room State)
           ↓
      mediasoup (创建 Producer/Consumer)
```

#### 4.2.4 媒体流传输（媒体流）

```
客户端 A → WebRTC (DTLS-SRTP) → mediasoup → 客户端 B
                                      ↓
                                录制到 MinIO
```

---

### 4.3 微服务拆分方案（长期）

#### 4.3.1 服务职责表

| 服务 | 职责 | 数据库 | 接口类型 |
|-----|------|--------|---------|
| **User Service** | 用户管理、认证授权 | PostgreSQL | REST |
| **Meeting Service** | 会议 CRUD、参会者管理 | PostgreSQL | REST |
| **Signaling Service** | WebRTC 信令、房间状态 | Redis | WebSocket |
| **Media Service** | 媒体流转发、录制 | N/A | WebRTC |
| **Notification Service** | 邮件、推送、短信 | PostgreSQL (队列) | gRPC |
| **Storage Service** | 文件上传下载 | MinIO/S3 | REST |
| **Analytics Service** | 数据统计、报表 | InfluxDB | REST |

#### 4.3.2 服务依赖关系

```
Meeting Service → User Service (验证用户)
Signaling Service → Meeting Service (验证会议)
Media Service → Signaling Service (获取房间信息)
Notification Service ← Meeting Service (发送通知)
```

---

### 4.4 容量规划表

#### 4.4.1 MVP 阶段（100 并发用户）

| 资源 | 规格 | 数量 | 说明 |
|-----|------|------|------|
| 应用服务器 | 4C8G | 1 | API + Signaling |
| 媒体服务器 | 8C16G | 1 | mediasoup |
| PostgreSQL | 4C8G | 1 | 主库 |
| Redis | 2C4G | 1 | 缓存 |
| 对象存储 | N/A | N/A | MinIO 本地部署 |
| **总成本** | - | - | **$150/月** |

#### 4.4.2 规模化阶段（1000 并发用户）

| 资源 | 规格 | 数量 | 说明 |
|-----|------|------|------|
| API 服务器 | 4C8G | 3 | 负载均衡 |
| 信令服务器 | 4C8G | 3 | WebSocket |
| 媒体服务器 | 16C32G | 5 | 集群部署 |
| PostgreSQL | 8C16G | 2 | 主从复制 |
| Redis | 4C8G | 2 | 主从 + 哨兵 |
| 对象存储 | N/A | N/A | S3 |
| **总成本** | - | - | **$2000/月** |

---

### 4.5 接口设计原则

#### 4.5.1 RESTful API 规范

```
GET    /api/v1/meetings          # 获取会议列表
POST   /api/v1/meetings          # 创建会议
GET    /api/v1/meetings/:id      # 获取会议详情
PUT    /api/v1/meetings/:id      # 更新会议
DELETE /api/v1/meetings/:id      # 删除会议
POST   /api/v1/meetings/:id/join # 加入会议
```

#### 4.5.2 响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "123",
    "title": "技术分享会"
  },
  "timestamp": 1678886400
}
```

#### 4.5.3 错误码设计

| 错误码 | 说明 |
|-------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 429 | 请求过于频繁 |
| 500 | 服务器内部错误 |

---

## 5. 质量保障

### 5.1 性能指标

| 指标 | 目标 | 监控方式 |
|-----|------|---------|
| API 响应时间 | P95 < 200ms | Prometheus |
| WebSocket 连接数 | 单机 10000+ | 业务日志 |
| 数据库查询时间 | P95 < 50ms | PostgreSQL 慢查询日志 |
| 缓存命中率 | >90% | Redis INFO |

### 5.2 可靠性指标

| 指标 | 目标 |
|-----|------|
| 服务可用性 | 99.9% |
| 故障恢复时间 (MTTR) | <5 分钟 |
| 数据持久性 | 99.999% |

### 5.3 可维护性指标

| 指标 | 目标 |
|-----|------|
| 代码覆盖率 | >80% |
| 日志完整度 | 100% |
| API 文档覆盖率 | 100% |

---

## 6. 参考资料

### 6.1 架构理论
- [Microservices Patterns](https://microservices.io/patterns/index.html)
- [The Twelve-Factor App](https://12factor.net/)
- [Martin Fowler - Microservices](https://martinfowler.com/articles/microservices.html)

### 6.2 开源项目
- [Jitsi Meet 架构](https://jitsi.github.io/handbook/docs/architecture)
- [Zoom 架构分析](https://blog.zoom.us/)

### 6.3 技术博客
- [Netflix 微服务实践](https://netflixtechblog.com/)
- [Uber 后端架构演进](https://eng.uber.com/)
