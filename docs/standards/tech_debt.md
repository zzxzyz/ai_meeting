# 技术债务管理规范

## 1. 什么是技术债务

### 1.1 定义
技术债务（Technical Debt）是指为了短期利益（快速交付）而采取的次优技术方案,导致未来需要额外工作来修复或重构的代码。

### 1.2 技术债务类型

| 类型 | 说明 | 示例 |
|-----|------|------|
| **架构债务** | 系统架构设计不合理 | 单体应用难以扩展 |
| **代码债务** | 代码质量差 | 重复代码、复杂度高 |
| **测试债务** | 测试覆盖率低 | 缺少单元测试、集成测试 |
| **文档债务** | 文档缺失或过时 | API 文档未更新 |
| **依赖债务** | 第三方库过时 | 使用老版本库,存在安全漏洞 |
| **性能债务** | 性能问题未解决 | 慢查询、内存泄漏 |
| **安全债务** | 安全漏洞未修复 | SQL 注入、XSS 漏洞 |

---

## 2. 技术债务登记

### 2.1 登记原则
- **及时记录**：发现技术债务立即登记
- **明确影响**：说明对业务和开发的影响
- **评估优先级**：按严重程度排序
- **制定计划**：明确偿还时间

---

### 2.2 技术债务模板

```markdown
## 技术债务 #001

**标题**：用户服务单体架构难以扩展

**类型**：架构债务

**发现时间**：2024-01-01

**发现人**：@zhangsan

**影响范围**：
- 用户服务
- 会议服务（依赖用户服务）

**问题描述**：
当前用户服务采用单体架构,所有功能耦合在一个代码库中。随着业务增长,出现以下问题：
1. 代码库过大（>50000 行）,难以维护
2. 部署时间长（>10 分钟）
3. 单个模块故障影响整个服务
4. 团队协作困难（多人修改冲突频繁）

**影响评估**：
- **业务影响**：中 - 影响新功能开发速度
- **技术影响**：高 - 难以扩展,维护成本高
- **安全影响**：低 - 暂无安全风险

**严重程度**：⚠️ 高

**偿还成本**：
- 预计工时：80 人天
- 涉及团队：后端团队、测试团队
- 风险：中（需要数据迁移）

**建议方案**：
1. 按领域拆分为微服务（用户、认证、权限）
2. 使用 API 网关统一入口
3. 逐步迁移（灰度发布）

**偿还计划**：
- Q2 2024: 设计微服务架构
- Q3 2024: 拆分用户服务
- Q4 2024: 迁移到生产环境

**关联 Issue**：
- #1234: 用户服务响应慢
- #1235: 用户服务部署失败

**更新日志**：
- 2024-01-01: 创建
- 2024-02-15: 架构设计评审通过
```

---

### 2.3 登记流程

```
1. 发现技术债务
   ↓
2. 创建 GitHub Issue (标签: tech-debt)
   ↓
3. 填写技术债务模板
   ↓
4. 团队评审（每月技术债务会议）
   ↓
5. 评估优先级
   ↓
6. 纳入 Backlog
   ↓
7. 制定偿还计划
   ↓
8. 执行偿还
   ↓
9. 验证效果
   ↓
10. 关闭 Issue
```

---

## 3. 技术债务评估

### 3.1 严重程度评估

| 严重程度 | 说明 | 偿还时间 |
|---------|------|---------|
| 🔴 **紧急** | 影响生产环境,必须立即解决 | 1 周内 |
| ⚠️ **高** | 严重影响开发效率或系统稳定性 | 1 个月内 |
| 🟡 **中** | 有一定影响,可计划解决 | 1 个季度内 |
| 🟢 **低** | 影响较小,可延后解决 | 1 年内 |

---

### 3.2 影响评估矩阵

```
影响程度 × 发生频率 = 严重程度

            低频    中频    高频
  高影响    中      高      紧急
  中影响    低      中      高
  低影响    低      低      中
```

**示例**：
- **高影响 + 高频**：生产环境频繁崩溃 → 🔴 紧急
- **高影响 + 低频**：偶尔出现的数据丢失 → 🟡 中
- **低影响 + 高频**：代码格式不统一 → 🟢 低

---

### 3.3 偿还成本评估

**考虑因素**：
- **工时**：预计需要多少人天
- **风险**：可能引入的新问题
- **依赖**：是否依赖其他模块
- **影响范围**：需要测试的范围
- **回滚成本**：失败后的回滚难度

**示例**：
```
技术债务: 数据库慢查询优化

工时: 5 人天
  - 分析慢查询: 1 天
  - 添加索引: 1 天
  - 优化 SQL: 2 天
  - 测试验证: 1 天

风险: 低
  - 添加索引不影响现有功能
  - 可灰度发布

依赖: 无

影响范围: 用户列表查询

回滚成本: 低（删除索引即可）
```

---

## 4. 技术债务偿还

### 4.1 偿还策略

#### 4.1.1 集中偿还
**适用**：严重的架构债务

**方式**：
- 设立专门的"偿还冲刺"（1-2 周）
- 暂停新功能开发
- 全员参与偿还

**优势**：
- 彻底解决问题
- 团队专注

**劣势**：
- 影响业务交付

---

#### 4.1.2 渐进偿还
**适用**：代码质量债务

**方式**：
- 每个迭代分配 20% 时间偿还
- 每个 Sprint 认领 1-2 个债务 Issue

**优势**：
- 不影响业务节奏
- 持续改进

**劣势**：
- 偿还周期长

---

#### 4.1.3 男孩军规则 (Boy Scout Rule)
**原则**：每次修改代码时,让代码比修改前更好

**方式**：
- 修复遇到的小问题
- 重构局部代码
- 添加缺失的注释

**优势**：
- 无额外成本
- 持续优化

**劣势**：
- 无法解决系统性问题

---

### 4.2 偿还流程

```bash
# 1. 创建偿还分支
git checkout -b tech-debt/001-refactor-user-service

# 2. 执行偿还
# - 重构代码
# - 添加测试
# - 更新文档

# 3. 提交 PR
# 标题: [Tech Debt] Refactor user service
# 描述: Resolves tech-debt #001

# 4. Code Review
# 重点检查:
# - 是否解决了原问题
# - 是否引入新问题
# - 测试覆盖率是否提升

# 5. 合并
git merge --no-ff tech-debt/001

# 6. 部署验证
# - 性能是否提升
# - 功能是否正常

# 7. 关闭 Issue
# 备注偿还效果
```

---

### 4.3 偿还效果验证

**指标**：
- **代码质量**：圈复杂度、重复率
- **测试覆盖率**：单元测试、集成测试
- **性能**：响应时间、吞吐量
- **可维护性**：代码行数、模块耦合度
- **故障率**：生产环境错误数

**示例**：
```
偿还前:
- 圈复杂度: 25
- 测试覆盖率: 45%
- API 响应时间 (P95): 800ms
- 生产环境错误: 50 次/天

偿还后:
- 圈复杂度: 8 (-68%)
- 测试覆盖率: 85% (+40%)
- API 响应时间 (P95): 200ms (-75%)
- 生产环境错误: 5 次/天 (-90%)
```

---

## 5. 预防技术债务

### 5.1 代码审查 (Code Review)

**审查重点**：
- 代码质量（复杂度、可读性）
- 测试覆盖率
- 设计模式
- 性能问题
- 安全问题

**拒绝标准**：
- 圈复杂度 >15
- 函数长度 >100 行
- 测试覆盖率 <80%
- 存在安全漏洞

---

### 5.2 自动化检查

**工具**：
- **ESLint**: JavaScript/TypeScript 代码检查
- **SonarQube**: 代码质量分析
- **Snyk**: 依赖漏洞扫描
- **Jest**: 测试覆盖率

**CI Pipeline**：
```yaml
# .github/workflows/code-quality.yml
name: Code Quality

on: [pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm test -- --coverage
      - run: |
          coverage=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "Coverage $coverage% is below 80%"
            exit 1
          fi

  sonar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

---

### 5.3 技术债务预算

**原则**：每个迭代预留 20% 时间偿还技术债务

**计算**：
```
2 周 Sprint = 10 工作日 = 80 小时
技术债务预算 = 80 × 20% = 16 小时

分配:
- 重构: 8 小时
- 补充测试: 4 小时
- 更新文档: 2 小时
- 依赖升级: 2 小时
```

---

## 6. 技术债务仪表盘

### 6.1 指标看板

```
┌─────────────────────────────────────────────┐
│       技术债务仪表盘 (2024-01)              │
├─────────────────────────────────────────────┤
│ 总债务数: 42                                │
│   🔴 紧急: 2                                │
│   ⚠️ 高: 8                                  │
│   🟡 中: 15                                 │
│   🟢 低: 17                                 │
├─────────────────────────────────────────────┤
│ 本月偿还: 5 个                              │
│ 偿还率: 12% (5/42)                          │
├─────────────────────────────────────────────┤
│ 代码质量指标:                                │
│   圈复杂度: 8.5                             │
│   重复率: 3.2%                              │
│   测试覆盖率: 82%                           │
├─────────────────────────────────────────────┤
│ 依赖漏洞:                                    │
│   严重: 0                                   │
│   高: 2                                     │
│   中: 5                                     │
└─────────────────────────────────────────────┘
```

---

### 6.2 趋势图

**技术债务数量趋势**：
```
50 ┤
45 ┤         ●
40 ┤      ●     ●
35 ┤   ●           ●
30 ┤●                 ●
25 ┼─────────────────────────
   Q1   Q2   Q3   Q4   Q1
  2023 2023 2023 2023 2024
```

**代码质量趋势**：
```
100%┤                    ●
 80%┤            ●    ●
 60%┤      ●  ●
 40%┤   ●
 20%┤●
    ┼─────────────────────────
   Q1   Q2   Q3   Q4   Q1
  2023 2023 2023 2023 2024
```

---

## 7. 最佳实践

### 7.1 定期回顾
- **每月技术债务会议**：评审新债务,制定偿还计划
- **季度质量报告**：分析债务趋势,调整策略

### 7.2 量化管理
- **债务总量上限**：不超过 50 个
- **紧急债务清零**：每月必须解决所有紧急债务
- **偿还率目标**：每月偿还 ≥10% 债务

### 7.3 文化建设
- **鼓励登记**：发现债务及时记录,不追责
- **奖励偿还**：偿还债务纳入绩效考核
- **分享经验**：定期分享偿还案例

---

## 8. 参考资料

- [Managing Technical Debt](https://martinfowler.com/bliki/TechnicalDebt.html)
- [Technical Debt Quadrant](https://martinfowler.com/bliki/TechnicalDebtQuadrant.html)
- [SonarQube](https://www.sonarqube.org/)
