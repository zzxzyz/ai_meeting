# 视频会议系统 - Agent Team 协作规范

## 一、项目概述

- **目标**：开发企业级视频会议软件（对标腾讯会议、Zoom）
- **核心能力**：多人实时音视频通话
- **开发方法**：TDD + 敏捷迭代
- **团队组织**：分层 Agent Team 架构（协调层 + 执行层）

## 二、Agent Team 架构

### 2.1 整体结构

```
主 Agent Team（协调层 - 7 个 Leader）
    ├── 产品经理 Agent ──── 产品 & UI/UX Team
    ├── 架构师 Agent   ──── 架构 Team
    ├── 前端 Leader    ──── 前端 Team
    ├── 后端 Leader    ──── 后端 Team
    ├── 客户端 Leader  ──── 客户端 Team
    ├── 测试 Leader    ──── 测试 Team
    └── 运维 Leader    ──── 运维 Team
```

**协作原则**：
1. **双重角色**：Leader 既参与主 Team 协调决策，也带领子 Team 执行
2. **垂直协作**：主 Team → 子 Team（需求分发、技术方案）
3. **水平协作**：子 Team 之间通过接口契约协作
4. **独立自治**：每个子 Team 在 Leader 协调下独立完成开发、测试、交付

### 2.2 主 Agent Team（协调层）

由 7 个子 Team Leader 组成，负责跨团队协调、版本管理、整体决策。

| Leader | 核心职责 | 输入 | 输出 |
|--------|---------|------|------|
| 产品经理 | 版本规划、需求分析、评审组织 | 业务目标、用户反馈 | PRD、评审报告 |
| 架构师 | 技术架构设计、方案评审 | 需求文档、技术约束 | ADR、接口规范 |
| 前端 Leader | 前端技术方案、工作协调 | 需求、架构设计 | 前端交付计划 |
| 后端 Leader | 后端技术方案、工作协调 | 需求、架构设计 | 后端交付计划 |
| 客户端 Leader | 客户端方案、平台协调 | 需求、架构设计 | 各平台 & SDK 交付计划 |
| 测试 Leader | 测试策略、质量把控 | 需求、代码 | 测试计划、质量报告 |
| 运维 Leader | 部署策略、环境管理 | 代码、部署需求 | 部署计划、运维报告 |

### 2.3 子 Agent Team（执行层）

#### 产品 & UI/UX Team

| Agent | 职责 |
|-------|------|
| 产品经理（Leader） | 版本规划、需求分析、评审组织 |
| UI/UX 设计师 | 交互设计、视觉设计、设计规范 |
| 产品助理（可选） | 需求调研、竞品分析 |
| UI 开发（可选） | 组件库开发、设计系统维护 |

#### 架构 Team

| Agent | 职责 |
|-------|------|
| 架构师（Leader） | 整体架构设计、技术方案评审 |
| 数据架构（可选） | 数据模型设计、存储方案 |
| 安全架构（可选） | 安全方案设计、加密方案 |

#### 前端 Team

| Agent | 职责 |
|-------|------|
| 前端 Leader | 前端架构、技术方案、任务分配 |
| 前端工程师 × N | 按功能模块拆分（会议室、用户管理、设置等） |

#### 后端 Team

| Agent | 职责 |
|-------|------|
| 后端 Leader | 后端架构、服务协调、任务分配 |
| 信令服务 | WebSocket/SIP 信令实现 |
| 媒体服务 | 媒体流转发、录制服务 |
| 业务服务 | 用户管理、会议管理、权限管理 |
| 数据库（可选） | 数据库表结构设计 |

#### 客户端 Team

| Agent | 职责 |
|-------|------|
| 客户端 Leader | 跨平台方案、SDK 架构设计、任务分配 |
| WebRTC 工程师 | WebRTC 集成与优化 |
| 编解码工程师 | 音视频编解码（H.264/VP8/Opus） |
| 媒体处理工程师 | 降噪、美颜、回声消除 |
| SDK 工程师 | 跨平台核心库封装与适配 |
| 平台工程师（iOS/Android/Windows/macOS/Linux） | 各平台客户端开发 |

> SDK 工程师优先交付 SDK，各平台工程师基于 SDK 开发。

#### 测试 Team

| Agent | 职责 |
|-------|------|
| 测试 Leader | 测试策略、测试计划、质量把控 |
| 集成测试 | 接口测试、跨 Team 集成测试 |
| 端到端测试 | 多端互通测试、业务流程测试 |
| 单元测试（可选） | 单元测试框架、覆盖率监控 |
| 性能测试（可选） | 性能测试、压力测试 |

#### 运维 Team

| Agent | 职责 |
|-------|------|
| 运维 Leader | 部署策略、环境管理、监控规划 |
| DevOps | CI/CD 流水线、自动化部署 |
| 监控（可选） | 监控告警、日志分析 |

---

## 三、迭代流程

### 3.1 项目初始化（首次执行）

项目启动前必须完成：MVP 需求列表定义、各端架构设计、构建系统选型。

| 交付物 | 存储路径 |
|--------|----------|
| 版本规划 | `docs/versions/v{version}/plan.md` |
| 版本需求列表 | `docs/versions/v{version}/requirements.md` |
| 架构设计 - 服务端 | `docs/architecture/server_design.md` |
| 架构设计 - Web 端 | `docs/architecture/web_design.md` |
| 架构设计 - 客户端 | `docs/architecture/client_design.md` |
| 构建系统 | `docs/architecture/build_system.md` |
| 接口契约模板 | `docs/api/contract_template.md` |

> 📎 架构师详细任务指南与调研规范参见 [架构师任务指南](./architecture_prompt.md)

### 3.2 版本规划

**负责人**：产品经理 Agent

- 版本号、目标、时间线与里程碑
- 功能需求列表（User Story）及优先级（P0/P1/P2）
- 各子 Team 需求分配与跨 Team 依赖关系
- **串行开发**：版本串行、需求串行，逐一完成

### 3.3 单个需求开发流程

```
需求分析 → UI/UX 设计 → 技术方案调研 → 评审 → 多 Team 并行开发（TDD） → 集成测试 → 部署
```

接口契约明确后，各 Team（前端、后端、客户端）可并行开发。

---

## 四、各阶段规范

### 4.1 需求分析

**负责人**：产品经理  
**输出**：PRD（需求背景、功能描述、Team 拆分、验收标准、优先级）  
**交付**：`docs/versions/v{version}/requirements/{req_id}/analysis.md`

### 4.2 UI/UX 设计

**负责人**：UI/UX 设计师  
**输出**：交互流程图、高保真设计稿（Web + 各平台）、设计规范  
**交付**：`docs/versions/v{version}/requirements/{req_id}/designs/`

### 4.3 技术方案调研

**负责人**：架构师  
**输出**：技术选型对比、可行性分析、风险评估  
**交付**：`docs/versions/v{version}/requirements/{req_id}/tech_research.md`

### 4.4 评审

**负责人**：产品经理 | **参与**：架构师、UI/UX 设计师、各 Team Leader  
**输出**：评审报告、接口契约（API/SDK 接口定义）、跨 Team 依赖  
**交付**：
- `docs/versions/v{version}/requirements/{req_id}/review.md`
- `docs/versions/v{version}/requirements/{req_id}/api_contract.md`

### 4.5 编码（TDD）

**负责人**：各子 Agent Team
**TDD 循环**：Red → Green → Refactor
**输出**：功能代码 + 单元测试 + API/SDK 文档
**覆盖率要求**：P0 ≥ 90%，P1 ≥ 80%，P2 ≥ 70%

**⚠️ 强制编译验证门禁（必须在标记完成前执行）**：

```bash
# 后端编码完成后必须执行
cd apps/backend && npx tsc --noEmit
# 期望输出：无任何错误

# 前端编码完成后必须执行
cd apps/web && npx vite build
# 期望输出：✓ built in X.Xs（无 error，warning 可接受）
```

完成标准：
- ✅ `tsc --noEmit` 零编译错误（后端）
- ✅ `vite build` 构建成功（前端）
- ✅ 所有 import 路径引用的文件实际存在
- ✅ 新增依赖已通过 `pnpm add` 安装
- ✅ 单元测试全部通过（`pnpm test`）
- ✅ 覆盖率达标
- ✅ 接口契约验证通过

**agent 编码 checklist（每位编码 agent 必须遵守）**：
1. 新建文件前确认目标路径
2. 写 import 时确认被引用文件存在（相对路径层数正确）
3. 使用新 npm 包前执行 `pnpm add <package>` 安装
4. 编码完成后执行对应的编译检查命令，将**实际输出**写入完成报告
5. 如编译出错，必须修复后再标记任务完成

### 4.6 测试

**负责人**：测试工程师
**层级**：单元测试 → 接口测试 → SDK 集成测试 → 端到端测试
**交付**：
- `docs/versions/v{version}/requirements/{req_id}/test_cases.md`
- `docs/versions/v{version}/requirements/{req_id}/test_report.md`

**⚠️ 测试报告诚信原则**：
- test_report 中的通过率必须来自**实际执行的命令输出**，不得凭主观判断填写
- 若无可运行环境，必须在报告中明确标注"设计验证"而非"已执行测试"
- test-leader 必须实际执行以下命令并将输出附在报告中：
  ```bash
  # 编译检查（必须实际执行）
  cd apps/backend && npx tsc --noEmit 2>&1 | tail -5
  cd apps/web && npx vite build 2>&1 | tail -5

  # 单元测试（如有）
  cd apps/backend && pnpm test 2>&1 | tail -20
  ```

**完成标准**：P0 通过率 100%、P1 ≥ 95%、无 P0/P1 缺陷、跨平台一致性通过、**编译检查通过**

### 4.7 部署

**负责人**：运维工程师  
**范围**：Web（CDN）、后端服务（信令/媒体/业务）、客户端（全平台）  
**完成标准**：各端正常运行，多端互通验证通过

---

## 五、异常处理

| 异常场景 | 处理方式 |
|---------|---------|
| 评审不通过（需求） | 回退至需求分析，重新走流程 |
| 评审不通过（设计） | 回退至 UI/UX 设计 |
| 评审不通过（技术方案） | 架构师调整方案，重新评审 |
| 评审不通过（接口契约） | 各 Leader 重新协商，更新契约 |
| 单元/集成测试不通过 | 对应 Team 修复后重新测试 |
| SDK 集成失败 | SDK 工程师修复，各平台重新集成 |
| 部署失败 | 排查修复后重新部署 |
| 需求变更 | 回退至需求分析，重新走流程 |
| 接口契约变更 | 所有相关 Team 确认并更新代码 |
| 依赖延期 | 调整计划或使用 Mock 数据先行开发 |

---

## 六、关键原则

1. **分层协作**：主 Team 协调，子 Team 执行
2. **串行推进**：单个需求完成后再开始下一个
3. **并行开发**：接口契约明确后各 Team 可并行
4. **TDD 强制**：先写测试，后写实现
5. **设计先行**：编码前必须完成 UI/UX 设计
6. **评审必过**：评审通过才能进入编码
7. **契约驱动**：跨 Team 协作必须先定义接口契约
8. **质量门禁**：覆盖率达标、测试全通过、无高优缺陷
9. **文档同步**：代码与文档同步更新，契约变更需通知相关 Team
10. **编译优先**：代码合并前必须通过 `tsc --noEmit`（后端）和 `vite build`（前端），编译错误视为 P0 缺陷
11. **测试诚信**：test_report 的通过率必须来自实际执行结果，不得预设通过，无环境时标注"设计验证"
12. **路径验证**：编码 agent 写完 import 后必须确认引用路径和文件存在，新依赖必须实际安装
